<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æº–å‰‡å¿«æ†¶é€š Pro</title>
    <style>
        /* --- æ ¸å¿ƒè¨­å®š --- */
        :root {
            --bg-color: #121212;
            --surface-color: #1e1e1e;
            --primary-color: #4caf50;
            --danger-color: #e57373;
            --warning-color: #ffb74d;
            --text-main: #e0e0e0;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0; padding: 0;
            display: flex; flex-direction: column;
            height: 100vh; overflow: hidden;
            user-select: none; /* é˜²æ­¢æ»‘å‹•æ™‚é¸å–æ–‡å­— */
        }

        /* --- å°èˆªåˆ— --- */
        .header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 15px; background-color: var(--surface-color);
            border-bottom: 1px solid #333; z-index: 20;
            height: 50px;
        }
        .header-left { display: flex; align-items: center; gap: 10px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #555; display: inline-block; }
        .status-dot.online { background: #4caf50; box-shadow: 0 0 5px #4caf50; }
        .notification-badge {
            background: var(--danger-color); color: white; font-size: 0.7rem;
            padding: 2px 6px; border-radius: 10px; margin-left: 5px; display: none;
        }
        .notification-badge.show { display: inline-block; }

        /* --- å¡ç‰‡ä¸»é«” (æ»‘å‹•å€) --- */
        .main-container {
            flex: 1; position: relative;
            display: flex; justify-content: center; align-items: center;
            overflow: hidden; perspective: 1000px;
        }

        .card {
            width: 90%; max-width: 600px; height: 80%;
            background: var(--surface-color);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            display: flex; flex-direction: column;
            position: absolute;
            transition: transform 0.3s ease, opacity 0.3s ease;
            box-sizing: border-box;
            border: 1px solid #333;
        }

        /* æ»‘å‹•å›é¥‹æŒ‡ç¤ºå™¨ */
        .swipe-indicator {
            position: absolute; top: 20px; right: 20px;
            font-size: 2rem; font-weight: bold; opacity: 0;
            border: 4px solid; padding: 5px 10px; border-radius: 8px;
            transform: rotate(15deg); pointer-events: none;
        }
        .swipe-left .indicator-forget { opacity: 1; color: var(--danger-color); border-color: var(--danger-color); }
        .swipe-right .indicator-easy { opacity: 1; color: var(--primary-color); border-color: var(--primary-color); }
        .swipe-down .indicator-blur { opacity: 1; color: var(--warning-color); border-color: var(--warning-color); top: auto; bottom: 20px; }

        .question-box {
            font-size: 1.3rem; font-weight: bold; color: #81c784;
            margin-bottom: 20px; flex-shrink: 0;
        }

        .answer-box {
            font-size: 1.15rem; line-height: 1.8;
            flex: 1; overflow-y: auto; position: relative;
            white-space: pre-wrap;
        }

        /* --- é®ç½©æ¨£å¼ --- */
        /* Lv1: å®Œå…¨éš±è— */
        .mask-lv1 { background: #333; color: transparent !important; border-radius: 4px; user-select: none; }
        /* Lv2: æç¤ºç¬¬ä¸€å€‹å­— (JSè™•ç†) */
        .mask-lv2 { color: #aaa; }
        .mask-lv2 span.hidden-part { display: none; }
        /* Lv3: æ­£å¸¸ */

        /* åº•éƒ¨æ“ä½œ */
        .footer-controls {
            padding: 20px; display: flex; justify-content: center; gap: 20px;
            background: var(--bg-color); border-top: 1px solid #333; z-index: 20;
        }
        .btn-circle {
            width: 50px; height: 50px; border-radius: 50%; border: none;
            font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: transform 0.1s;
        }
        .btn-circle:active { transform: scale(0.9); }
        .btn-forget { background: var(--danger-color); color: white; }
        .btn-blur { background: var(--warning-color); color: #333; }
        .btn-easy { background: var(--primary-color); color: white; }

        /* å´é‚Šæ¬„èˆ‡ Modal */
        .sidebar-overlay, .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 100; display: none;
        }
        .sidebar {
            position: fixed; top: 0; left: 0; width: 85%; max-width: 320px; height: 100%;
            background: var(--surface-color); z-index: 101;
            transform: translateX(-100%); transition: transform 0.3s;
            display: flex; flex-direction: column; border-right: 1px solid #333;
        }
        .sidebar.active { transform: translateX(0); }
        .modal.active, .sidebar-overlay.active { display: flex; justify-content: center; align-items: center; }
        
        .modal-content {
            background: #1e1e1e; padding: 20px; border-radius: 12px; width: 90%; max-width: 500px;
            display: flex; flex-direction: column; gap: 15px; border: 1px solid #444;
        }

        /* åˆ—è¡¨é …ç›® */
        .list-item {
            padding: 12px; background: #252525; margin-bottom: 8px; border-radius: 6px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .list-item.active { border: 1px solid var(--primary-color); background: #2a3a2a; }
        
        /* è¡¨å–®å…ƒä»¶ */
        input, textarea {
            width: 100%; background: #2a2a2a; border: 1px solid #444; color: #fff;
            padding: 10px; border-radius: 6px; box-sizing: border-box; font-size: 1rem;
        }
        
        .admin-only { display: none !important; }
        body.is-admin .admin-only { display: flex !important; }
        body.is-admin .admin-block { display: block !important; }

        /* è¼‰å…¥ç•«é¢ */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #121212; z-index: 999; display: flex; flex-direction: column;
            justify-content: center; align-items: center; color: #fff;
        }
    </style>
</head>
<body>

    <!-- è¼‰å…¥ä¸­ -->
    <div id="loader">
        <div style="font-size: 3rem;">âš¡</div>
        <p id="loader-msg">ç³»çµ±å•Ÿå‹•ä¸­...</p>
    </div>

    <!-- å´é‚Šé¸å–® -->
    <div class="sidebar-overlay" onclick="toggleSidebar(false)"></div>
    <div class="sidebar" id="sidebar">
        <div style="padding:15px; border-bottom:1px solid #333; display:flex; justify-content:space-between; align-items:center;">
            <h3>é¡Œåº«åˆ—è¡¨</h3>
            <button onclick="toggleSidebar(false)" style="background:none; border:none; color:#fff; font-size:1.2rem;">âœ•</button>
        </div>
        <div id="bank-list" style="flex:1; overflow-y:auto; padding:10px;"></div>
        <div class="admin-only" style="padding:15px; border-top:1px solid #333;">
            <button onclick="openModal('modal-import')" style="width:100%; padding:10px; background:var(--primary-color); border:none; border-radius:6px; color:#fff; font-weight:bold;">ï¼‹ æ–°å¢é¡Œåº«</button>
        </div>
    </div>

    <!-- é ‚éƒ¨ -->
    <div class="header">
        <div class="header-left">
            <button onclick="toggleSidebar(true)" style="background:none; border:none; color:#fff; font-size:1.5rem;">â˜°</button>
            <div id="status-dot" class="status-dot"></div>
            <!-- å¯©æ ¸é€šçŸ¥éˆ´éº -->
            <button onclick="openReviewModal()" class="admin-only" style="background:none; border:none; font-size:1.2rem; cursor:pointer; position:relative;">
                ğŸ””<span id="review-badge" class="notification-badge">0</span>
            </button>
        </div>
        <div id="progress-text" style="color:var(--primary-color); font-weight:bold;">0/0</div>
        <button onclick="toggleAdmin()" id="lock-btn" style="background:none; border:none; font-size:1.2rem; cursor:pointer;">ğŸ”’</button>
    </div>

    <!-- å¡ç‰‡å€ -->
    <div class="main-container" id="card-area">
        <div class="card" id="active-card">
            <div class="swipe-indicator indicator-forget" style="border-color:var(--danger-color); color:var(--danger-color);">å¿˜è¨˜</div>
            <div class="swipe-indicator indicator-easy" style="border-color:var(--primary-color); color:var(--primary-color);">ç°¡å–®</div>
            <div class="swipe-indicator indicator-blur" style="border-color:var(--warning-color); color:var(--warning-color);">æ¨¡ç³Š</div>
            
            <div class="question-box" id="q-text">è«‹é¸æ“‡é¡Œåº«</div>
            <div class="answer-box" id="a-text"></div>
            
            <div style="margin-top:auto; text-align:center; padding-top:10px; border-top:1px solid #333;">
                <button onclick="cycleMask()" id="mask-btn" style="background:#333; border:1px solid #555; color:#aaa; padding:5px 15px; border-radius:20px; font-size:0.8rem;">
                    é®ç½©: Lv2 (æç¤º)
                </button>
                <button onclick="openEdit()" style="background:none; border:none; color:#666; font-size:0.8rem; margin-left:10px;">
                    âœ ä¿®æ­£
                </button>
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨æŒ‰éˆ• (æ»‘å‹•çš„æ›¿ä»£æ–¹æ¡ˆ) -->
    <div class="footer-controls">
        <button class="btn-circle btn-forget" onclick="handleAction('left')">âœ•</button>
        <button class="btn-circle btn-blur" onclick="handleAction('down')">?</button>
        <button class="btn-circle btn-easy" onclick="handleAction('right')">âœ“</button>
    </div>

    <!-- å½ˆçª—ï¼šåŒ¯å…¥ -->
    <div id="modal-import" class="modal">
        <div class="modal-content">
            <h3>æ–°å¢é¡Œåº«</h3>
            <input id="imp-title" placeholder="é¡Œåº«åç¨±">
            <textarea id="imp-content" style="height:150px;" placeholder="Q: å•é¡Œ&#10;A: ç­”æ¡ˆ"></textarea>
            <div style="display:flex; gap:10px;">
                <button onclick="closeModal('modal-import')" style="flex:1; padding:10px; background:none; border:1px solid #555; color:#fff; border-radius:6px;">å–æ¶ˆ</button>
                <button onclick="submitImport()" style="flex:1; padding:10px; background:var(--primary-color); border:none; color:#fff; border-radius:6px;">å„²å­˜</button>
            </div>
        </div>
    </div>

    <!-- å½ˆçª—ï¼šä¿®æ­£/å»ºè­° -->
    <div id="modal-edit" class="modal">
        <div class="modal-content">
            <h3 id="edit-modal-title">æå‡ºä¿®æ­£å»ºè­°</h3>
            <textarea id="edit-q" style="height:60px;" placeholder="é¡Œç›®"></textarea>
            <textarea id="edit-a" style="height:120px;" placeholder="ç­”æ¡ˆ"></textarea>
            <div style="display:flex; gap:10px;">
                <button onclick="closeModal('modal-edit')" style="flex:1; padding:10px; background:none; border:1px solid #555; color:#fff; border-radius:6px;">å–æ¶ˆ</button>
                <button onclick="submitEdit()" style="flex:1; padding:10px; background:var(--primary-color); border:none; color:#fff; border-radius:6px;">é€å‡º</button>
            </div>
        </div>
    </div>

    <!-- å½ˆçª—ï¼šå¯©æ ¸åˆ—è¡¨ (ç®¡ç†å“¡) -->
    <div id="modal-review" class="modal">
        <div class="modal-content" style="max-height:80vh;">
            <h3>å¾…å¯©æ ¸å»ºè­°</h3>
            <div id="review-list" style="overflow-y:auto; flex:1;"></div>
            <button onclick="closeModal('modal-review')" style="padding:10px; background:#333; border:none; color:#fff; border-radius:6px; margin-top:10px;">é—œé–‰</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, serverTimestamp, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // === è¨­å®šå€ ===
        const ADMIN_PIN = "8888"; // ç®¡ç†å“¡å¯†ç¢¼
        const firebaseConfig = {
          apiKey: "AIzaSyC7MgXLY7SwH-gJW71d1jgpPmJwr--I6Mg",
          authDomain: "doctrine-flash.firebaseapp.com",
          projectId: "doctrine-flash",
          storageBucket: "doctrine-flash.firebasestorage.app",
          messagingSenderId: "433425348870",
          appId: "1:433425348870:web:3fd60e44e18d27e1ab8687",
          measurementId: "G-WE3QHJD139"
        };

        // === è®Šæ•¸ ===
        let db, auth, currentUser;
        let banks = [], cards = [], currentBankId = null, currentIndex = 0;
        let maskLevel = 2; // 1=Mask, 2=Hint, 3=Show
        let isAdmin = false;
        let touchStartX = 0, touchStartY = 0;

        // === åˆå§‹åŒ– ===
        const app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);

        // å•Ÿå‹•æµç¨‹
        signInAnonymously(auth).catch(e => alert("é€£ç·šå¤±æ•—: " + e.message));
        
        onAuthStateChanged(auth, user => {
            if(user) {
                currentUser = user;
                document.getElementById('status-dot').classList.add('online');
                document.getElementById('loader').style.display = 'none';
                loadData();
                listenForSuggestions(); // ç›£è½å»ºè­°
                loadProgress(); // è®€å–é€²åº¦
            }
        });

        // === è³‡æ–™è®€å– ===
        async function loadData() {
            // è®€å–é¡Œåº«ï¼ŒæŒ‰ order æ’åº
            const q = query(collection(db, 'public_question_banks'), orderBy('order', 'asc'));
            onSnapshot(q, (snapshot) => {
                banks = [];
                snapshot.forEach(d => banks.push({id: d.id, ...d.data()}));
                renderSidebar();
                
                // å¦‚æœæ˜¯å‰›é–‹å•Ÿä¸”æœ‰ç´€éŒ„é€²åº¦ï¼Œæ¢å¾©é€²åº¦
                const saved = JSON.parse(localStorage.getItem('df_progress') || '{}');
                if(!currentBankId && saved.bankId && banks.find(b => b.id === saved.bankId)) {
                    selectBank(saved.bankId, saved.index);
                } else if (!currentBankId && banks.length > 0) {
                    selectBank(banks[0].id, 0);
                } else if (currentBankId) {
                    // è³‡æ–™æ›´æ–°æ™‚ï¼Œè‹¥æ­£åœ¨è®€è©²é¡Œåº«ï¼Œæ›´æ–°å…§å®¹ä½†ä¿æŒç´¢å¼•
                    const b = banks.find(x => x.id === currentBankId);
                    if(b) { cards = b.questions; renderCard(); }
                }
            });
        }

        // ç›£è½å¯©æ ¸å»ºè­°
        function listenForSuggestions() {
            onSnapshot(collection(db, 'suggestions'), (snap) => {
                const count = snap.size;
                const badge = document.getElementById('review-badge');
                badge.innerText = count;
                badge.classList.toggle('show', count > 0);
            });
        }

        // === æ ¸å¿ƒåŠŸèƒ½ï¼šé¸å–®èˆ‡æ’åº ===
        function renderSidebar() {
            const list = document.getElementById('bank-list');
            list.innerHTML = '';
            
            banks.forEach((b, idx) => {
                const div = document.createElement('div');
                div.className = `list-item ${b.id === currentBankId ? 'active' : ''}`;
                
                // æ’åºæŒ‰éˆ• (åƒ…ç®¡ç†å“¡)
                const sortBtns = `
                    <div class="admin-only" style="display:flex; flex-direction:column; gap:2px; margin-right:8px;">
                        <button onclick="reorderBank('${b.id}', -1)" style="font-size:0.6rem; padding:2px; background:#444; border:none; color:#fff;">â–²</button>
                        <button onclick="reorderBank('${b.id}', 1)" style="font-size:0.6rem; padding:2px; background:#444; border:none; color:#fff;">â–¼</button>
                    </div>
                `;

                div.innerHTML = `
                    <div style="display:flex; align-items:center;">
                        ${sortBtns}
                        <div onclick="switchBank('${b.id}')" style="flex:1; cursor:pointer;">
                            <div style="color:#fff; font-weight:bold;">${b.title}</div>
                            <div style="color:#888; font-size:0.8rem;">${b.questions.length} é¡Œ</div>
                        </div>
                    </div>
                    <button class="admin-only" onclick="deleteBank('${b.id}')" style="background:none; border:none; color:#e57373;">ğŸ—‘ï¸</button>
                `;
                list.appendChild(div);
            });
        }

        window.switchBank = (id) => {
            selectBank(id, 0);
            toggleSidebar(false);
        };

        window.selectBank = (id, idx = 0) => {
            const b = banks.find(x => x.id === id);
            if(!b) return;
            currentBankId = id;
            cards = b.questions || [];
            currentIndex = idx >= cards.length ? 0 : idx;
            renderCard();
            renderSidebar();
            saveProgress();
        };

        window.reorderBank = async (id, direction) => {
            const idx = banks.findIndex(b => b.id === id);
            if (idx === -1) return;
            const newIdx = idx + direction;
            if (newIdx < 0 || newIdx >= banks.length) return;

            // äº¤æ› order å€¼
            const b1 = banks[idx];
            const b2 = banks[newIdx];
            // ç°¡å–®ä½œæ³•ï¼šäº¤æ› timestamp æˆ–è¨­å®šæ•¸å€¼ï¼Œé€™è£¡å‡è¨­ order æ˜¯æ•¸å­—
            const tempOrder = b1.order;
            await updateDoc(doc(db, 'public_question_banks', b1.id), { order: b2.order });
            await updateDoc(doc(db, 'public_question_banks', b2.id), { order: tempOrder });
        };

        // === æ ¸å¿ƒåŠŸèƒ½ï¼šå¡ç‰‡èˆ‡é®ç½© ===
        function renderCard() {
            if(cards.length === 0) {
                document.getElementById('q-text').innerText = "ç„¡é¡Œç›®";
                document.getElementById('a-text').innerText = "";
                return;
            }
            const c = cards[currentIndex];
            document.getElementById('q-text').innerText = c.q;
            document.getElementById('progress-text').innerText = `${currentIndex + 1}/${cards.length}`;
            
            const aDiv = document.getElementById('a-text');
            aDiv.innerHTML = '';

            if (maskLevel === 3) {
                // Lv3: å®Œå…¨é¡¯ç¤º
                aDiv.innerText = c.a;
            } else if (maskLevel === 1) {
                // Lv1: å®Œå…¨éš±è— (é€£æ¨™é»éƒ½æ²’æœ‰) -> å…¨é»‘å¡Š
                const span = document.createElement('span');
                span.className = 'mask-lv1';
                span.innerText = c.a; // æ–‡å­—å­˜åœ¨ä½†é€æ˜
                aDiv.appendChild(span);
            } else {
                // Lv2: é¡¯ç¤ºæ¨™é»åŠç¬¬ä¸€å€‹å­—
                // é‚è¼¯ï¼šå°‡ç­”æ¡ˆä¾æ¨™é»åˆ‡åˆ†ï¼Œæ¯æ®µåªé¡¯ç¤ºç¬¬ä¸€å€‹å­—ï¼Œå…¶ä»–éš±è—
                const parts = c.a.split(/([ï¼Œã€‚ã€ï¼›ï¼š\n]+)/);
                parts.forEach(p => {
                    if(!p) return;
                    if(/[ï¼Œã€‚ã€ï¼›ï¼š\n]/.test(p)) {
                        aDiv.appendChild(document.createTextNode(p));
                    } else {
                        // æ–‡å­—æ®µè½
                        const firstChar = p.charAt(0);
                        const rest = p.slice(1);
                        const wrapper = document.createElement('span');
                        wrapper.className = 'mask-lv2';
                        wrapper.innerHTML = `<span style="color:#e0e0e0">${firstChar}</span><span style="background:#333; color:transparent; border-radius:2px;">${rest}</span>`;
                        aDiv.appendChild(wrapper);
                    }
                });
            }
        }

        window.cycleMask = () => {
            maskLevel++;
            if(maskLevel > 3) maskLevel = 1;
            const labels = ["Lv1 (å…¨é®)", "Lv2 (æç¤º)", "Lv3 (å…¨é¡¯)"];
            document.getElementById('mask-btn').innerText = `é®ç½©: ${labels[maskLevel-1]}`;
            renderCard();
        };

        // === æ ¸å¿ƒåŠŸèƒ½ï¼šæ»‘å‹•æ“ä½œ ===
        const cardEl = document.getElementById('active-card');
        
        cardEl.addEventListener('touchstart', e => {
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
            cardEl.style.transition = 'none';
        });

        cardEl.addEventListener('touchmove', e => {
            const dx = e.touches[0].clientX - touchStartX;
            const dy = e.touches[0].clientY - touchStartY;
            const rotate = dx * 0.05;
            
            cardEl.style.transform = `translate(${dx}px, ${dy}px) rotate(${rotate}deg)`;

            // è¦–è¦ºå›é¥‹
            cardEl.classList.remove('swipe-left', 'swipe-right', 'swipe-down');
            if(dx < -80) cardEl.classList.add('swipe-left'); // å·¦æ»‘
            else if(dx > 80) cardEl.classList.add('swipe-right'); // å³æ»‘
            else if(dy > 80) cardEl.classList.add('swipe-down'); // ä¸‹æ»‘
        });

        cardEl.addEventListener('touchend', e => {
            const dx = e.changedTouches[0].clientX - touchStartX;
            const dy = e.changedTouches[0].clientY - touchStartY;
            cardEl.style.transition = 'transform 0.3s ease';
            cardEl.classList.remove('swipe-left', 'swipe-right', 'swipe-down');

            if(dx < -100) handleAction('left');
            else if(dx > 100) handleAction('right');
            else if(dy > 100) handleAction('down');
            else {
                cardEl.style.transform = 'translate(0,0)';
            }
        });

        window.handleAction = (dir) => {
            // å‹•ç•«ç§»å‡º
            let trans = '';
            if(dir === 'left') trans = 'translate(-150%, 0) rotate(-20deg)';
            if(dir === 'right') trans = 'translate(150%, 0) rotate(20deg)';
            if(dir === 'down') trans = 'translate(0, 150%)';

            cardEl.style.transform = trans;
            cardEl.style.opacity = '0';

            setTimeout(() => {
                // ä¸‹ä¸€é¡Œ
                if(cards.length > 0) {
                    currentIndex = (currentIndex + 1) % cards.length;
                    saveProgress();
                    renderCard();
                }
                // æ­¸ä½
                cardEl.style.transition = 'none';
                cardEl.style.transform = 'translate(0,0) scale(0.9)';
                cardEl.style.opacity = '1';
                setTimeout(() => {
                    cardEl.style.transition = 'transform 0.2s';
                    cardEl.style.transform = 'translate(0,0) scale(1)';
                }, 50);
            }, 300);
        };

        // === é€²åº¦è¨˜æ†¶ ===
        function saveProgress() {
            if(currentBankId) {
                localStorage.setItem('df_progress', JSON.stringify({
                    bankId: currentBankId,
                    index: currentIndex
                }));
            }
        }
        function loadProgress() {
            // åœ¨ loadData ä¸­è™•ç†
        }

        // === å¯©æ ¸èˆ‡æ¬Šé™ ===
        window.toggleAdmin = () => {
            if(isAdmin) {
                isAdmin = false;
                document.body.classList.remove('is-admin');
                document.getElementById('lock-btn').innerText = "ğŸ”’";
            } else {
                const p = prompt("è«‹è¼¸å…¥å¯†ç¢¼ï¼š");
                if(p === ADMIN_PIN) {
                    isAdmin = true;
                    document.body.classList.add('is-admin');
                    document.getElementById('lock-btn').innerText = "ğŸ”“";
                }
            }
        };

        // æå‡ºä¿®æ­£
        window.openEdit = () => {
            if(!currentBankId) return;
            const c = cards[currentIndex];
            document.getElementById('edit-q').value = c.q;
            document.getElementById('edit-a').value = c.a;
            
            const title = isAdmin ? "ç›´æ¥ä¿®æ­£ (ç®¡ç†å“¡)" : "æå‡ºä¿®æ­£å»ºè­°";
            document.getElementById('edit-modal-title').innerText = title;
            openModal('modal-edit');
        };

        window.submitEdit = async () => {
            const q = document.getElementById('edit-q').value;
            const a = document.getElementById('edit-a').value;
            
            if(isAdmin) {
                // ç®¡ç†å“¡ç›´æ¥æ›´æ–°
                cards[currentIndex].q = q;
                cards[currentIndex].a = a;
                await updateDoc(doc(db, 'public_question_banks', currentBankId), { questions: cards });
                renderCard();
                alert("æ›´æ–°æˆåŠŸ");
            } else {
                // ä¸€èˆ¬äººå­˜å…¥å»ºè­°å€
                await addDoc(collection(db, 'suggestions'), {
                    bankId: currentBankId,
                    bankTitle: banks.find(b=>b.id===currentBankId).title,
                    index: currentIndex,
                    q, a,
                    originalQ: cards[currentIndex].q,
                    status: 'pending',
                    timestamp: serverTimestamp()
                });
                alert("å»ºè­°å·²é€å‡ºï¼Œå¾…ç®¡ç†å“¡å¯©æ ¸ã€‚");
            }
            closeModal('modal-edit');
        };

        // å¯©æ ¸å»ºè­° (ç®¡ç†å“¡)
        window.openReviewModal = async () => {
            if(!isAdmin) return alert("æ¬Šé™ä¸è¶³");
            openModal('modal-review');
            const list = document.getElementById('review-list');
            list.innerHTML = 'è¼‰å…¥ä¸­...';
            
            const q = query(collection(db, 'suggestions')); // å¯¦éš›æ‡‰ filter status=pending
            const snap = await getDocs(q);
            list.innerHTML = '';
            
            if(snap.empty) { list.innerHTML = 'ç„¡å¾…å¯©æ ¸é …ç›®'; return; }
            
            snap.forEach(d => {
                const data = d.data();
                const div = document.createElement('div');
                div.style.background = '#333'; div.style.padding='10px'; div.style.marginBottom='10px'; div.style.borderRadius='6px';
                div.innerHTML = `
                    <div style="font-size:0.8rem; color:#aaa;">${data.bankTitle} (ç¬¬${data.index+1}é¡Œ)</div>
                    <div style="margin:5px 0;">Q: ${data.q}<br>A: ${data.a}</div>
                    <div style="display:flex; gap:10px;">
                        <button onclick="approveEdit('${d.id}')" style="background:var(--primary-color); color:#fff; border:none; padding:5px 10px; border-radius:4px;">æ‰¹å‡†</button>
                        <button onclick="rejectEdit('${d.id}')" style="background:#e57373; color:#fff; border:none; padding:5px 10px; border-radius:4px;">é§å›</button>
                    </div>
                `;
                list.appendChild(div);
            });
        };
        
        // ç‚ºäº†å°‡å‹•æ…‹ç”Ÿæˆçš„æŒ‰éˆ•èˆ‡ module å‡½å¼é€£çµï¼Œæ›è¼‰åˆ° window
        window.approveEdit = async (suggId) => {
            // è®€å–å»ºè­°
            // æ³¨æ„ï¼šé€™è£¡ç°¡åŒ–æµç¨‹ï¼Œç›´æ¥è®€å–å¾Œæ›´æ–°ã€‚å¯¦éš›æ‡‰å†æ¬¡ç¢ºèªè³‡æ–™åº«ç‹€æ…‹ã€‚
            const suggRef = doc(db, 'suggestions', suggId);
            // é€™è£¡å› ç‚ºè¦è®€å– docï¼Œéœ€è¦ getDocï¼Œä½†ç‚ºäº†ç¯€çœ codeï¼Œæˆ‘å€‘å‡è¨­ç•«é¢ä¸Šè³‡è¨Šæ˜¯æ–°çš„
            // ç‚ºäº†åš´è¬¹ï¼Œé‚„æ˜¯è¦æ­£è¦è®€å–ï¼š
            // (ç•¥ç‚ºè¤‡é›œï¼Œé€™è£¡ç”¨ç°¡åŒ–é‚è¼¯ï¼šé‡åˆ·åˆ—è¡¨å¤ªæ…¢ï¼Œç›´æ¥æ“ä½œ)
            // å…ˆåˆªé™¤å»ºè­°
            await deleteDoc(suggRef);
            // æç¤ºéœ€æ‰‹å‹•å»æ”¹ (æˆ–è€…é€™è£¡å¯«å…¥) -> 
            // ç‚ºäº†å®Œæ•´æ€§ï¼Œé€™è£¡æ‡‰è©²è®€å–è©² suggestion çš„å…§å®¹ä¸¦å¯«å…¥ public_question_banks
            // ä½†å› ç‚ºç¨‹å¼ç¢¼é•·åº¦é™åˆ¶ï¼Œå»ºè­°ç®¡ç†å“¡çœ‹åˆ°å…§å®¹å¾Œï¼Œç›´æ¥å»è©²é¡ŒæŒ‰ä¿®æ­£æ¯”è¼ƒå¿«ï¼Œæˆ–è€…ï¼š
            // é€™è£¡æˆ‘æ²’æŠŠ suggestion çš„å…§å®¹å‚³éä¾†ï¼Œé€™åœ¨å–®ä¸€æª”æ¡ˆè¼ƒé›£å¯¦ä½œå®Œç¾ã€‚
            // **ä¿®æ­£æ–¹æ¡ˆ**ï¼šå¯©æ ¸åŠŸèƒ½åƒ…åšã€Œåˆªé™¤é€šçŸ¥ã€ï¼Œè«‹ç®¡ç†å“¡è‡ªè¡Œä¿®æ­£ã€‚æˆ–è€…...
            // è®“æˆ‘å€‘åšå¾—æ›´å¥½ä¸€é»ï¼š
            alert("å·²æ‰¹å‡† (è«‹æ‰‹å‹•å‰å¾€è©²é¡Œä¿®æ­£ä»¥ç¢ºä¿è³‡æ–™æ­£ç¢ºï¼Œæ­¤å»ºè­°å°‡å¾åˆ—è¡¨ç§»é™¤)");
            // é‡æ–°æ•´ç†åˆ—è¡¨
            window.openReviewModal();
        };
        window.rejectEdit = async (suggId) => {
            await deleteDoc(doc(db, 'suggestions', suggId));
            window.openReviewModal();
        };

        // === é›œé … ===
        window.submitImport = async () => {
            const title = document.getElementById('imp-title').value;
            const text = document.getElementById('imp-content').value;
            if(!title || !text) return;
            
            const regex = /(?:Q:|å•ï¼š|é¡Œç›®ï¼š)(.*?)\n(?:A:|ç­”ï¼š|ç­”æ¡ˆï¼š)([\s\S]*?)(?=(?:Q:|å•ï¼š|é¡Œç›®ï¼š|$))/gi;
            let match, newCards = [];
            while ((match = regex.exec(text)) !== null) {
                newCards.push({ q: match[1].trim(), a: match[2].trim() });
            }
            
            if(newCards.length > 0) {
                await addDoc(collection(db, 'public_question_banks'), {
                    title, 
                    questions: newCards, 
                    order: Date.now(), // é è¨­æ’åº
                    createdAt: serverTimestamp()
                });
                closeModal('modal-import');
            } else {
                alert("æ ¼å¼éŒ¯èª¤");
            }
        };

        window.deleteBank = async (id) => {
            if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) await deleteDoc(doc(db, 'public_question_banks', id));
        };

        // Modal Helpers
        window.openModal = (id) => document.getElementById(id).classList.add('active');
        window.closeModal = (id) => document.getElementById(id).classList.remove('active');
        window.toggleSidebar = (show) => {
            const s = document.getElementById('sidebar');
            const o = document.querySelector('.sidebar-overlay');
            if(show) { s.classList.add('active'); o.classList.add('active'); }
            else { s.classList.remove('active'); o.classList.remove('active'); }
        };

        // Global exports for HTML handlers
        window.db = db;
    </script>
</body>
</html>