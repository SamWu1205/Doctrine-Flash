<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æº–å‰‡å¿«æ†¶é€š SRS v2</title>
    <style>
        /* --- æ ¸å¿ƒè¨­å®š --- */
        :root {
            --bg-color: #121212;
            --surface-color: #1e1e1e;
            --primary-color: #4caf50;
            --secondary-color: #2196f3;
            --danger-color: #e57373;
            --warning-color: #ffb74d;
            --text-main: #e0e0e0;
            --text-sub: #aaaaaa;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0; padding: 0;
            display: flex; flex-direction: column;
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        /* --- å°èˆªåˆ— --- */
        .header {
            display: flex;
            justify-content: space-between; align-items: center;
            padding: 10px 15px; background-color: var(--surface-color);
            border-bottom: 1px solid #333; z-index: 20;
            height: 50px;
        }
        .header-left { display: flex; align-items: center; gap: 10px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #555; display: inline-block; }
        .status-dot.online { background: #4caf50; box-shadow: 0 0 5px #4caf50; }
        .notification-badge {
            background: var(--danger-color);
            color: white; font-size: 0.7rem;
            padding: 2px 6px; border-radius: 10px; margin-left: 5px; display: none;
        }
        .notification-badge.show { display: inline-block; }

        /* --- å·¥å…·åˆ— --- */
        .toolbar {
            display: flex;
            gap: 8px; overflow-x: auto; padding: 10px;
            background: #181818; border-bottom: 1px solid #333;
        }
        .tool-btn {
            background: #333;
            color: #ccc; border: 1px solid #444;
            padding: 5px 12px; border-radius: 15px; font-size: 0.85rem;
            white-space: nowrap; cursor: pointer; display: flex;
            align-items: center; gap: 5px;
        }
        .tool-btn:active { background: #444; }

        /* --- å¡ç‰‡ä¸»é«” (æ»‘å‹•å€) --- */
        .main-container {
            flex: 1;
            position: relative;
            display: flex; justify-content: center; align-items: center;
            overflow: hidden; perspective: 1000px;
        }

        .card {
            width: 90%;
            max-width: 600px; height: 85%;
            background: var(--surface-color);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            display: flex; flex-direction: column;
            position: absolute;
            transition: transform 0.3s ease, opacity 0.3s ease;
            box-sizing: border-box;
            border: 1px solid #333;
        }

        /* ä»»å‹™å®Œæˆçš„ç©ºç‹€æ…‹ */
        .empty-state {
            text-align: center;
            color: #777; display: none;
        }
        .empty-state.show { display: block; }
        .empty-state h2 { color: var(--primary-color); margin-bottom: 10px; }

        .swipe-indicator {
            position: absolute;
            top: 20px; right: 20px;
            font-size: 2rem; font-weight: bold; opacity: 0;
            border: 4px solid; padding: 5px 10px; border-radius: 8px;
            transform: rotate(15deg);
            pointer-events: none;
        }
        .swipe-left .indicator-forget { opacity: 1; color: var(--danger-color); border-color: var(--danger-color); }
        .swipe-right .indicator-easy { opacity: 1; color: var(--primary-color); border-color: var(--primary-color); }
        .swipe-down .indicator-blur { opacity: 1; color: var(--warning-color); border-color: var(--warning-color); top: auto; bottom: 20px; }

        .question-meta {
            font-size: 0.8rem;
            color: #666; margin-bottom: 5px; display: flex; justify-content: space-between;
        }
        .question-box {
            font-size: 1.3rem;
            font-weight: bold; color: #81c784;
            margin-bottom: 20px; flex-shrink: 0;
        }

        .answer-box {
            font-size: 1.15rem;
            line-height: 1.8;
            flex: 1; overflow-y: auto; position: relative;
            white-space: pre-wrap;
        }

        /* --- é®ç½©æ¨£å¼å„ªåŒ– (é•·åº¦ä¸€è‡´ã€èƒŒæ™¯èåˆ) --- */
        .mask-lv1, .mask-hidden {
            display: inline-block;
            width: 60px; /* å›ºå®šå¯¬åº¦ï¼Œéš±è—å­—æ•¸è³‡è¨Š */
            height: 1.2rem;
            background: var(--surface-color); /* èˆ‡å¡ç‰‡èƒŒæ™¯ç›¸åŒ */
            color: transparent !important;
            user-select: none;
            vertical-align: bottom;
            border-bottom: 2px solid #555; /* å¾®å¾®çš„åº•ç·šæç¤ºé€™è£¡æœ‰æŒ–ç©º */
            margin: 0 4px;
        }
        .mask-lv2 { color: #aaa; }

        /* --- å°è€ƒæ¨¡å¼æ‰‹å¯«å€èˆ‡å°ç­”æ¡ˆ --- */
        .quiz-area {
            display: none;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
            width: 100%;
        }
        .quiz-area.active { display: flex; }
        .quiz-input {
            width: 100%; height: 80px;
            background: #181818; border: 1px solid #444; color: #fff;
            padding: 10px; border-radius: 8px; resize: none; font-size: 1.1rem;
            box-sizing: border-box;
        }
        .quiz-submit-btn {
            padding: 10px; background: var(--secondary-color); border: none;
            color: #fff; border-radius: 6px; font-weight: bold; cursor: pointer;
        }
        .quiz-submit-btn:active { background: #1976d2; }

        /* å°ç­”æ¡ˆå·®ç•°æ¨™ç¤º */
        .diff-correct { color: #4caf50; }
        .diff-wrong { color: var(--danger-color); text-decoration: line-through; opacity: 0.8; }
        .diff-missing { color: var(--danger-color); font-weight: bold; border-bottom: 1px dashed var(--danger-color); }

        /* --- åº•éƒ¨æ§åˆ¶åˆ— --- */
        .control-bar {
            display: flex;
            justify-content: space-between; align-items: center;
            margin-top: auto; padding-top: 15px; border-top: 1px solid #333;
        }
        .nav-btn {
            background: #2a2a2a;
            border: 1px solid #444; color: #fff;
            width: 40px; height: 40px; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-size: 1.2rem;
            cursor: pointer;
        }
        .nav-btn:active { background: #444; }

        /* å´é‚Šæ¬„èˆ‡ Modal */
        .sidebar-overlay, .modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 100; display: none;
        }
        .sidebar {
            position: fixed;
            top: 0; left: 0; width: 85%; max-width: 320px; height: 100%;
            background: var(--surface-color); z-index: 101;
            transform: translateX(-100%); transition: transform 0.3s;
            display: flex; flex-direction: column; border-right: 1px solid #333;
        }
        .sidebar.active { transform: translateX(0); }
        .modal.active, .sidebar-overlay.active { display: flex; justify-content: center; align-items: center; }
        
        .modal-content {
            background: #1e1e1e;
            padding: 20px; border-radius: 12px; width: 90%; max-width: 500px;
            display: flex; flex-direction: column; gap: 15px; border: 1px solid #444; max-height: 85vh;
        }

        .list-item {
            padding: 12px;
            background: #252525; margin-bottom: 8px; border-radius: 6px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .list-item.active { border: 1px solid var(--primary-color); background: #2a3a2a; }
        
        /* è¡¨æ ¼æ¨£å¼ (ç†Ÿæ‚‰åº¦) */
        .status-table {
            width: 100%;
            border-collapse: collapse; font-size: 0.9rem;
        }
        .status-table th { text-align: left; color: #888; padding: 5px; border-bottom: 1px solid #444; }
        .status-table td { padding: 8px 5px; border-bottom: 1px solid #333; color: #ddd; }
        .status-row:active { background: #333; }
        
        input, textarea, select {
            width: 100%;
            background: #2a2a2a; border: 1px solid #444; color: #fff;
            padding: 10px; border-radius: 6px; box-sizing: border-box; font-size: 1rem;
        }
        .row-inputs { display: flex; gap: 10px; }

        .admin-only { display: none !important; }
        body.is-admin .admin-only { display: flex !important; }

        #loader {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #121212; z-index: 999; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            color: #fff;
        }
        
        /* æ¨¡å¼åˆ‡æ›æŒ‰éˆ• */
        .mode-switch {
            display: flex;
            background: #333; border-radius: 20px; padding: 2px; margin-right: 10px;
        }
        .mode-btn {
            padding: 5px 12px;
            border-radius: 18px; border: none; background: transparent; color: #aaa; font-size: 0.8rem; cursor: pointer;
        }
        .mode-btn.active { background: var(--primary-color); color: #fff; }
        
        .tag-review { color: var(--danger-color); font-size: 0.8rem; border: 1px solid var(--danger-color); padding: 1px 4px; border-radius: 4px; }
        .tag-future { color: var(--primary-color); font-size: 0.8rem; }
        .tag-new { color: var(--text-sub); font-size: 0.8rem; }

    </style>
</head>
<body>

    <div id="loader">
        <div style="font-size: 3rem;">âš¡</div>
        <p id="loader-msg">ç³»çµ±å•Ÿå‹•ä¸­...</p>
    </div>

    <div class="sidebar-overlay" onclick="toggleSidebar(false)"></div>
    <div class="sidebar" id="sidebar">
        <div style="padding:15px; border-bottom:1px solid #333; display:flex; justify-content:space-between; align-items:center;">
            <h3>é¡Œåº«åˆ—è¡¨</h3>
            <button onclick="toggleSidebar(false)" style="background:none; border:none; color:#fff; font-size:1.2rem;">âœ•</button>
        </div>
        <div id="bank-list" style="flex:1; overflow-y:auto; padding:10px;"></div>
        <div class="admin-only" style="padding:15px; border-top:1px solid #333;">
            <button onclick="openModal('modal-import')" style="width:100%; padding:10px; background:var(--primary-color); border:none; border-radius:6px; color:#fff; font-weight:bold;">ï¼‹ æ–°å¢é¡Œåº«</button>
        </div>
    </div>

    <div class="header">
        <div class="header-left">
            <button onclick="toggleSidebar(true)" style="background:none; border:none; color:#fff; font-size:1.5rem;">â˜°</button>
            <div id="status-dot" class="status-dot"></div>
            <button onclick="openReviewModal()" class="admin-only" style="background:none; border:none; font-size:1.2rem; cursor:pointer; position:relative;">
                ğŸ””<span id="review-badge" class="notification-badge">0</span>
            </button>
        </div>
        
        <div class="mode-switch">
            <button class="mode-btn active" id="mode-smart" onclick="setMode('smart')">æ™ºæ…§</button>
            <button class="mode-btn" id="mode-cram" onclick="setMode('cram')">ç€è¦½</button>
        </div>

        <button onclick="toggleAdmin()" id="lock-btn" style="background:none; border:none; font-size:1.2rem; cursor:pointer;">ğŸ”’</button>
    </div>

    <div class="toolbar">
        <button class="tool-btn" onclick="openSettings()">âš™ï¸ ç¯„åœ/éš¨æ©Ÿ</button>
        <button class="tool-btn" onclick="openStatusList()">ğŸ“‹ ç†Ÿæ‚‰åº¦/åˆ—è¡¨</button>
        <button class="tool-btn" onclick="toggleQuizMode()" id="quiz-mode-btn">âœï¸ å°è€ƒæ¨¡å¼: é—œ</button>
    </div>

    <div class="main-container" id="card-area">
        
        <div id="empty-state" class="empty-state">
            <div style="font-size: 4rem;">ğŸ‰</div>
            <h2>ä»»å‹™å®Œæˆ</h2>
            <p>ç›®å‰æ¢ä»¶ä¸‹æ²’æœ‰é¡Œç›®äº†ã€‚</p>
            <div style="display:flex; gap:10px; justify-content:center; margin-top:20px;">
                <button onclick="openSettings()" style="padding:8px 20px; background:#333; color:#fff; border:1px solid #555; border-radius:20px;">èª¿æ•´ç¯„åœ</button>
                <button onclick="setMode('cram'); openSettings('reset');" style="padding:8px 20px; background:var(--primary-color); color:#fff; border:none; border-radius:20px;">å…¨éƒ¨é‡ç·´</button>
            </div>
        </div>

        <div class="card" id="active-card">
            <div class="swipe-indicator indicator-forget" style="border-color:var(--danger-color); color:var(--danger-color);">å¿˜è¨˜</div>
            <div class="swipe-indicator indicator-easy" style="border-color:var(--primary-color); color:var(--primary-color);">ç°¡å–®</div>
            <div class="swipe-indicator indicator-blur" style="border-color:var(--warning-color); color:var(--warning-color);">æ¨¡ç³Š</div>
            
            <div class="question-meta">
                <span id="q-index">#1</span>
                <span>å¾…è¤‡ç¿’: <span id="queue-count" style="color:var(--primary-color);">0</span></span>
            </div>
            
            <div class="question-box" id="q-text">è«‹é¸æ“‡é¡Œåº«</div>
            
            <div class="answer-box" id="a-text"></div>

            <div class="quiz-area" id="quiz-area">
                <textarea id="quiz-input" class="quiz-input" placeholder="è«‹åœ¨æ­¤è¼¸å…¥ç­”æ¡ˆ..."></textarea>
                <button class="quiz-submit-btn" onclick="submitQuiz()">äº¤å·ä¸¦å°ç­”æ¡ˆ</button>
            </div>
            
            <div class="control-bar">
                <button class="nav-btn" onclick="undoAction()">â†©</button>
                
                <div style="display:flex; gap:10px;">
                    <button onclick="cycleMask()" id="mask-btn" style="background:#333; border:1px solid #555; color:#aaa; padding:5px 15px; border-radius:20px; font-size:0.8rem;">
                        é®ç½©: Lv1
                    </button>
                    <button onclick="openEdit()" style="background:none; border:none; color:#666; font-size:0.8rem;">
                        âœ ä¿®æ­£
                    </button>
                </div>

                <button class="nav-btn" onclick="skipAction()">â¡</button>
            </div>
        </div>
    </div>

    <div id="modal-settings" class="modal">
        <div class="modal-content">
            <h3>ğŸ“– æŠ½é¡Œç¯„åœè¨­å®š</h3>
            <div>
                <label style="color:#aaa; font-size:0.9rem;">é¡Œç›®å€é–“ (ç¸½é¡Œæ•¸: <span id="total-q-count">0</span>)</label>
                <div class="row-inputs" style="margin-top:5px;">
                    <input type="number" id="set-start" placeholder="èµ·å§‹" value="1">
                    <span style="align-self:center;">~</span>
                    <input type="number" id="set-end" placeholder="çµæŸ">
                </div>
            </div>
            
            <div style="display:flex; align-items:center; gap:10px; margin-top:10px;">
                <input type="checkbox" id="set-random" style="width:20px; height:20px;">
                <label for="set-random" style="color:#fff;">éš¨æ©ŸæŠ½é¡Œ</label>
            </div>
            
            <div id="random-count-box" style="display:none; margin-top:5px;">
                <label style="color:#aaa; font-size:0.9rem;">æŠ½å–æ•¸é‡</label>
                <input type="number" id="set-count" value="20">
                
                <div style="margin-top:10px;">
                    <label style="color:#aaa; font-size:0.9rem;">å‡ºé¡Œä½”æ¯” (æ˜“/ä¸­/é›£ %) åŠ ç¸½ç‚º100</label>
                    <div class="row-inputs" style="margin-top:5px;">
                        <input type="number" id="set-easy" placeholder="æ˜“" value="30">
                        <input type="number" id="set-mid" placeholder="ä¸­" value="40">
                        <input type="number" id="set-hard" placeholder="é›£" value="30">
                    </div>
                </div>
            </div>

            <div style="display:flex; gap:10px; margin-top:15px;">
                <button onclick="closeModal('modal-settings')" style="flex:1; padding:10px; background:none; border:1px solid #555; color:#fff; border-radius:6px;">å–æ¶ˆ</button>
                <button onclick="applySettings()" style="flex:1; padding:10px; background:var(--primary-color); border:none; color:#fff; border-radius:6px;">ç¢ºèªä¸¦é–‹å§‹</button>
            </div>
        </div>
    </div>

    <div id="modal-status" class="modal">
        <div class="modal-content">
            <h3>ğŸ“Š é¡Œç›®ç†Ÿæ‚‰åº¦ä¸€è¦½</h3>
            <div style="overflow-y:auto; flex:1; border:1px solid #333; border-radius:4px;">
                <table class="status-table">
                    <thead>
                        <tr>
                            <th style="width:15%">#</th>
                            <th>é¡Œç›®é è¦½</th>
                            <th style="width:30%">ä¸‹æ¬¡è¤‡ç¿’</th>
                        </tr>
                    </thead>
                    <tbody id="status-list-body"></tbody>
                </table>
            </div>
            <button onclick="closeModal('modal-status')" style="padding:10px; background:#333; border:none; color:#fff; border-radius:6px; margin-top:10px;">é—œé–‰</button>
        </div>
    </div>

    <div id="modal-import" class="modal">
        <div class="modal-content">
            <h3>æ–°å¢é¡Œåº«</h3>
            <input id="imp-title" placeholder="é¡Œåº«åç¨±">
            <textarea id="imp-content" style="height:150px;" placeholder="Q: å•é¡Œ&#10;A: ç­”æ¡ˆ"></textarea>
            <div style="display:flex; gap:10px;">
                <button onclick="closeModal('modal-import')" style="flex:1; padding:10px; background:none; border:1px solid #555; color:#fff; border-radius:6px;">å–æ¶ˆ</button>
                <button onclick="submitImport()" style="flex:1; padding:10px; background:var(--primary-color); border:none; color:#fff; border-radius:6px;">å„²å­˜</button>
            </div>
        </div>
    </div>

    <div id="modal-edit" class="modal">
        <div class="modal-content">
            <h3 id="edit-modal-title">æå‡ºä¿®æ­£å»ºè­°</h3>
            <textarea id="edit-q" style="height:60px;" placeholder="é¡Œç›®"></textarea>
            <textarea id="edit-a" style="height:120px;" placeholder="ç­”æ¡ˆ"></textarea>
            <div style="display:flex; gap:10px;">
                <button onclick="closeModal('modal-edit')" style="flex:1; padding:10px; background:none; border:1px solid #555; color:#fff; border-radius:6px;">å–æ¶ˆ</button>
                <button onclick="submitEdit()" style="flex:1; padding:10px; background:var(--primary-color); border:none; color:#fff; border-radius:6px;">é€å‡º</button>
            </div>
        </div>
    </div>

    <div id="modal-review" class="modal">
        <div class="modal-content" style="max-height:80vh;">
            <h3>å¾…å¯©æ ¸å»ºè­°</h3>
            <div id="review-list" style="overflow-y:auto; flex:1;"></div>
            <button onclick="closeModal('modal-review')" style="padding:10px; background:#333; border:none; color:#fff; border-radius:6px; margin-top:10px;">é—œé–‰</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, serverTimestamp, query, orderBy, onSnapshot, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // === è¨­å®šå€ ===
        const ADMIN_PIN = "1001";
        
        const firebaseConfig = {
          apiKey: "AIzaSyC7MgXLY7SwH-gJW71d1jgpPmJwr--I6Mg",
          authDomain: "doctrine-flash.firebaseapp.com",
          projectId: "doctrine-flash",
          storageBucket: "doctrine-flash.firebasestorage.app",
          messagingSenderId: "433425348870",
          appId: "1:433425348870:web:3fd60e44e18d27e1ab8687",
          measurementId: "G-WE3QHJD139"
        };

        // === å…¨åŸŸè®Šæ•¸ ===
        let db, auth, currentUser;
        let banks = [];
        let allCards = []; 
        let studyQueue = []; 
        let historyStack = []; // ä¸Šä¸€é¡Œå †ç–Š
        let currentBankId = null;
        let maskLevel = 1; // é è¨­ Lv1
        let isAdmin = false;
        let touchStartX = 0, touchStartY = 0;
        let studyMode = 'smart'; 
        let progressMap = {};
        
        let filterConfig = {
            active: false, start: 1, end: 0, isRandom: false, randomCount: 20,
            ratioEasy: 30, ratioMid: 40, ratioHard: 30
        };
        let isQuizMode = false; // å°è€ƒæ¨¡å¼ç‹€æ…‹

        // === åˆå§‹åŒ– ===
        const app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);

        signInAnonymously(auth).catch(e => alert("é€£ç·šå¤±æ•—: " + e.message));
        
        onAuthStateChanged(auth, user => {
            if(user) {
                currentUser = user;
                document.getElementById('status-dot').classList.add('online');
                document.getElementById('loader').style.display = 'none';
                loadBanks();
                listenForSuggestions();
            }
        });

        // === 1. è®€å–é¡Œåº«åˆ—è¡¨ ===
        function loadBanks() {
            const q = query(collection(db, 'public_question_banks'));
            onSnapshot(q, (snapshot) => {
                banks = [];
                snapshot.forEach(d => {
                    const data = d.data();
                    if(data.order === undefined) { 
                        updateDoc(doc(db, 'public_question_banks', d.id), { order: Date.now() });
                    }
                    banks.push({id: d.id, ...data});
                });
                banks.sort((a,b) => (a.order || 0) - (b.order || 0));
                renderSidebar();
                
                const saved = JSON.parse(localStorage.getItem('df_progress') || '{}');
                if(!currentBankId && saved.bankId && banks.find(b => b.id === saved.bankId)) {
                    selectBank(saved.bankId);
                }
            });
        }

        // === 2. é¸æ“‡é¡Œåº« & è¨­å®š ===
        window.selectBank = async (id) => {
            const b = banks.find(x => x.id === id);
            if(!b) return;
            
            currentBankId = id;
            allCards = b.questions || [];
            localStorage.setItem('df_progress', JSON.stringify({ bankId: id }));
            // é‡ç½®ç¯©é¸é è¨­å€¼
            filterConfig = { active: false, start: 1, end: allCards.length, isRandom: false, randomCount: 20, ratioEasy: 30, ratioMid: 40, ratioHard: 30 };
            
            // è®€å–é€²åº¦
            const progRef = doc(db, 'users', currentUser.uid, 'progress', id);
            const progSnap = await getDoc(progRef);
            progressMap = progSnap.exists() ? progSnap.data().reviews || {} : {};

            buildQueue(); 
            renderSidebar();
        };

        window.setMode = (mode) => {
            studyMode = mode;
            document.getElementById('mode-smart').className = mode === 'smart' ? 'mode-btn active' : 'mode-btn';
            document.getElementById('mode-cram').className = mode === 'cram' ? 'mode-btn active' : 'mode-btn';
            if(currentBankId) buildQueue();
        };

        // é–‹å•Ÿè¨­å®šé¢æ¿
        window.openSettings = (action) => {
            if(!currentBankId) return alert("è«‹å…ˆé¸æ“‡é¡Œåº«");
            if(action === 'reset') {
                filterConfig = { active: false, start: 1, end: allCards.length, isRandom: false, randomCount: 20, ratioEasy: 30, ratioMid: 40, ratioHard: 30 };
                buildQueue();
                return;
            }
            document.getElementById('total-q-count').innerText = allCards.length;
            document.getElementById('set-end').value = allCards.length; // é è¨­æœ€å¤§å€¼
            document.getElementById('set-random').checked = false;
            document.getElementById('random-count-box').style.display = 'none';
            openModal('modal-settings');
        };

        // ç›£è½éš¨æ©Ÿcheckbox
        document.getElementById('set-random').addEventListener('change', (e) => {
            document.getElementById('random-count-box').style.display = e.target.checked ? 'block' : 'none';
        });

        // æ‡‰ç”¨è¨­å®šä¸¦é‡å»ºéšŠåˆ—
        window.applySettings = () => {
            const s = parseInt(document.getElementById('set-start').value) || 1;
            const e = parseInt(document.getElementById('set-end').value) || allCards.length;
            const rnd = document.getElementById('set-random').checked;
            const cnt = parseInt(document.getElementById('set-count').value) || 20;
            const easy = parseInt(document.getElementById('set-easy').value) || 0;
            const mid = parseInt(document.getElementById('set-mid').value) || 0;
            const hard = parseInt(document.getElementById('set-hard').value) || 0;

            filterConfig = {
                active: true,
                start: Math.max(1, s),
                end: Math.min(allCards.length, e),
                isRandom: rnd,
                randomCount: cnt,
                ratioEasy: easy,
                ratioMid: mid,
                ratioHard: hard
            };
            
            buildQueue();
            closeModal('modal-settings');
        };

        function buildQueue() {
            studyQueue = [];
            historyStack = []; // æ¸…ç©ºæ­·å²
            const now = Date.now();
            let candidates = [];

            // 1. å…ˆå»ºç«‹å€™é¸æ±  (æ ¹æ“šç¯„åœ)
            for(let i=0; i<allCards.length; i++) {
                if(i + 1 >= filterConfig.start && i + 1 <= filterConfig.end) {
                    candidates.push(i);
                }
            }

            // 2. éš¨æ©Ÿèˆ‡æ¯”ä¾‹è™•ç†
            if(filterConfig.isRandom) {
                // å°‡å€™é¸åå–®åˆ†ç‚º æ˜“(interval>5), ä¸­(0<interval<=5), é›£(interval==0/ç„¡)
                let easyPool=[], midPool=[], hardPool=[];
                candidates.forEach(i => {
                    const inv = progressMap[i]?.interval || 0;
                    if(inv === 0) hardPool.push(i);
                    else if(inv <= 5) midPool.push(i);
                    else easyPool.push(i);
                });

                // æ‰“äº‚é™£åˆ—çš„ Helper
                const shuffle = (arr) => arr.sort(() => 0.5 - Math.random());
                shuffle(easyPool); shuffle(midPool); shuffle(hardPool);

                // è¨ˆç®—å„é›£åº¦æ‡‰æŠ½æ•¸é‡
                let total = filterConfig.randomCount;
                let cEasy = Math.floor(total * (filterConfig.ratioEasy / 100));
                let cMid = Math.floor(total * (filterConfig.ratioMid / 100));
                let cHard = total - cEasy - cMid; // å‰©é¤˜çµ¦é›£

                // å¦‚æœæŸå€‹æ± ä¸å¤ ï¼Œå°±å¾å…¶ä»–æ± è£œ
                let finalPool = [
                    ...easyPool.splice(0, cEasy),
                    ...midPool.splice(0, cMid),
                    ...hardPool.splice(0, cHard)
                ];
                
                // è‹¥æ•¸é‡é‚„æ˜¯ä¸å¤ è¨­å®šå€¼ï¼ŒæŠŠå‰©ä¸‹çš„äº‚åºè£œä¸Š
                const leftovers = shuffle([...easyPool, ...midPool, ...hardPool]);
                while(finalPool.length < total && leftovers.length > 0) {
                    finalPool.push(leftovers.pop());
                }

                studyQueue = shuffle(finalPool);
            } else {
                // æ™ºæ…§æ¨¡å¼ä¸”ç„¡è‡ªè¨‚ç¯„åœï¼šåªåŠ å…¥åˆ°æœŸå¡ï¼›å¦å‰‡å…¨åŠ 
                if (studyMode === 'smart' && !filterConfig.active) {
                    studyQueue = candidates.filter(i => (progressMap[i]?.nextReview || 0) <= now);
                } else {
                    studyQueue = candidates;
                }
            }
            renderCard();
        }

        // === 3. æ¸²æŸ“å¡ç‰‡ ===
        function renderCard() {
            const cardEl = document.getElementById('active-card');
            const emptyEl = document.getElementById('empty-state');
            const qCount = document.getElementById('queue-count');
            const maskBtn = document.getElementById('mask-btn');
            const quizArea = document.getElementById('quiz-area');
            const quizInput = document.getElementById('quiz-input');

            if(studyQueue.length === 0) {
                cardEl.style.display = 'none';
                emptyEl.classList.add('show');
                qCount.innerText = "0";
                return;
            }

            // Reset Card Style
            cardEl.style.display = 'flex';
            cardEl.style.transform = 'translate(0,0) rotate(0deg)';
            cardEl.style.opacity = '1';
            emptyEl.classList.remove('show');
            qCount.innerText = studyQueue.length;

            const idx = studyQueue[0]; 
            const c = allCards[idx];
            document.getElementById('q-index').innerText = `#${idx + 1}`;
            document.getElementById('q-text').innerText = c.q;
            
            const aDiv = document.getElementById('a-text');
            aDiv.innerHTML = '';

            // UI æ§åˆ¶ï¼šå°è€ƒæ¨¡å¼åˆ‡æ›
            maskBtn.innerText = `é®ç½©: Lv${maskLevel}`;
            maskBtn.style.display = isQuizMode ? 'none' : 'block';
            quizArea.classList.toggle('active', isQuizMode);
            quizInput.value = ''; // æ¸…ç©ºè¼¸å…¥æ¡†

            // é®ç½©èˆ‡æ–‡å­—æ¸²æŸ“é‚è¼¯
            if (isQuizMode) {
                aDiv.innerHTML = '<span style="color:#666; font-size:0.9rem;">(å°è€ƒæ¨¡å¼ï¼šè«‹åœ¨ä¸‹æ–¹ä½œç­”ä¸¦äº¤å·)</span>';
            } else if (maskLevel === 3) {
                aDiv.innerText = c.a;
            } else if (maskLevel === 1) {
                aDiv.innerHTML = `<span class="mask-lv1"></span>`; 
            } else {
                const parts = (c.a || "").split(/([ï¼Œã€‚ã€ï¼›ï¼š\n]+)/);
                parts.forEach(p => {
                    if(!p) return;
                    if(/[ï¼Œã€‚ã€ï¼›ï¼š\n]/.test(p)) aDiv.appendChild(document.createTextNode(p));
                    else {
                        const first = p.charAt(0);
                        const wrapper = document.createElement('span');
                        wrapper.className = 'mask-lv2';
                        // ä½¿ç”¨å›ºå®šå¤§å°çš„å‡å€å¡Šéš±è—çœŸå¯¦å­—æ•¸
                        wrapper.innerHTML = `<span style="color:#e0e0e0">${first}</span><span class="mask-hidden"></span>`;
                        aDiv.appendChild(wrapper);
                    }
                });
            }
        }

        // === 4. å‹•ä½œèˆ‡å°èˆª ===
        
        // åˆ‡æ›å°è€ƒæ¨¡å¼
        window.toggleQuizMode = () => {
            isQuizMode = !isQuizMode;
            document.getElementById('quiz-mode-btn').innerText = isQuizMode ? 'âœï¸ å°è€ƒæ¨¡å¼: é–‹' : 'âœï¸ å°è€ƒæ¨¡å¼: é—œ';
            renderCard();
        };

        // äº¤å·ä¸¦å°ç­”æ¡ˆ
        window.submitQuiz = () => {
            if(studyQueue.length === 0) return;
            const c = allCards[studyQueue[0]];
            const target = (c.a || "").trim();
            const input = document.getElementById('quiz-input').value.trim();
            
            // ä½¿ç”¨ LCS (æœ€é•·å…±åŒå­åºåˆ—) æ¼”ç®—æ³•æ¨™ç¤ºå·®ç•°
            const diffHtml = generateDiffHtml(target, input);
            
            const aDiv = document.getElementById('a-text');
            aDiv.innerHTML = `
                <div style="font-size:0.9rem; color:#aaa; margin-bottom:5px;">æ¯”å°çµæœï¼š</div>
                <div style="line-height:1.6; font-size:1.1rem; padding-bottom:10px; border-bottom:1px solid #333;">${diffHtml}</div>
                <div style="margin-top:10px; font-size:0.9rem; color:#aaa;">åŸæ­£ç¢ºç­”æ¡ˆï¼š</div>
                <div style="color:#fff;">${target}</div>
            `;
            // éš±è—è¼¸å…¥å€ï¼Œè®“ä½¿ç”¨è€…å°ˆå¿ƒçœ‹ç­”æ¡ˆä¸¦è©•åˆ†æ»‘å‹•
            document.getElementById('quiz-area').classList.remove('active');
        };

        // æ ¸å¿ƒæ–‡å­—æ¯”å°æ¼”ç®—æ³• (å‹•æ…‹è¦åŠƒ)
        function generateDiffHtml(correct, user) {
            let m = correct.length, n = user.length;
            let dp = Array(m+1).fill(0).map(()=>Array(n+1).fill(0));
            
            for(let i=1; i<=m; i++) {
                for(let j=1; j<=n; j++) {
                    if(correct[i-1] === user[j-1]) dp[i][j] = dp[i-1][j-1] + 1;
                    else dp[i][j] = Math.max(dp[i-1][j], dp[i][j-1]);
                }
            }
            
            let i = m, j = n, res = [];
            while(i > 0 || j > 0) {
                if(i > 0 && j > 0 && correct[i-1] === user[j-1]) {
                    // æ‰“å°çš„å­— (é¡¯ç¤ºç‚ºç¶ è‰²)
                    res.unshift(`<span class="diff-correct">${correct[i-1]}</span>`);
                    i--; j--;
                } else if(j > 0 && (i === 0 || dp[i][j-1] >= dp[i-1][j])) {
                    // ä½¿ç”¨è€…å¤šæ‰“çš„å­— (é¡¯ç¤ºç‚ºç´…è‰²åˆªé™¤ç·š)
                    res.unshift(`<span class="diff-wrong">${user[j-1]}</span>`);
                    j--;
                } else if(i > 0 && (j === 0 || dp[i][j-1] < dp[i-1][j])) {
                    // ä½¿ç”¨è€…æ¼æ‰“/éŒ¯æ‰“çš„æ­£ç¢ºå­— (é¡¯ç¤ºç‚ºç´…è‰²è™›åº•ç·š)
                    res.unshift(`<span class="diff-missing">${correct[i-1]}</span>`);
                    i--;
                }
            }
            return res.join('');
        }

        // è©•åˆ†èˆ‡æ»‘å‹•
        window.handleAction = async (dir) => {
            if(studyQueue.length === 0) return;
            const cardEl = document.getElementById('active-card');
            let trans = '';
            if(dir === 'left') trans = 'translate(-150%, 0) rotate(-20deg)'; // å¿˜è¨˜
            if(dir === 'right') trans = 'translate(150%, 0) rotate(20deg)'; // ç°¡å–®
            if(dir === 'down') trans = 'translate(0, 150%)'; // æ¨¡ç³Š
            
            cardEl.style.transition = 'transform 0.3s ease, opacity 0.3s ease';
            cardEl.style.transform = trans;
            cardEl.style.opacity = '0';

            const currentIndex = studyQueue.shift(); 
            historyStack.push(currentIndex); // å­˜å…¥æ­·å²ï¼Œä¾›ä¸Šä¸€é¡Œä½¿ç”¨
            
            const now = Date.now();
            // æ¼”ç®—æ³•è¨ˆç®—
            if (studyMode === 'smart') {
                let interval = progressMap[currentIndex]?.interval || 0;
                let nextReview = 0;

                if (dir === 'right') { 
                    if (interval === 0) interval = 1;
                    else interval = Math.ceil(interval * 2.5); 
                    nextReview = now + (interval * 24 * 60 * 60 * 1000);
                } else if (dir === 'down') {
                    interval = 0;
                    nextReview = now; 
                    studyQueue.push(currentIndex); 
                } else {
                    interval = 0;
                    nextReview = now;
                    const insertPos = Math.min(studyQueue.length, 3);
                    studyQueue.splice(insertPos, 0, currentIndex);
                }

                progressMap[currentIndex] = { nextReview, interval };
                const progRef = doc(db, 'users', currentUser.uid, 'progress', currentBankId);
                setDoc(progRef, { reviews: progressMap }, { merge: true });
            } else {
                // Cram æ¨¡å¼å¾ªç’°
                if (dir !== 'right') {
                    studyQueue.push(currentIndex);
                }
            }

            setTimeout(() => {
                cardEl.style.transition = 'none';
                renderCard();
            }, 300);
        };

        // ä¸Šä¸€é¡Œ (Undo)
        window.undoAction = () => {
            if(historyStack.length === 0) return alert("å·²ç¶“æ˜¯ç¬¬ä¸€é¡Œäº†");
            const prevIndex = historyStack.pop();
            studyQueue.unshift(prevIndex); // æ”¾å›é–‹é ­
            
            // è¦–è¦ºç‰¹æ•ˆï¼šå¾å·¦é‚Šé£›é€²ä¾†
            const cardEl = document.getElementById('active-card');
            cardEl.style.transition = 'none';
            cardEl.style.transform = 'translate(-150%, 0)';
            renderCard(); // å…ˆæ¸²æŸ“å…§å®¹
            
            setTimeout(() => {
                cardEl.style.transition = 'transform 0.3s ease';
                cardEl.style.transform = 'translate(0,0)';
            }, 10);
        };

        // ä¸‹ä¸€é¡Œ (Skip - ä¸è©•åˆ†ï¼Œç›´æ¥æ”¾å¾Œé¢)
        window.skipAction = () => {
            if(studyQueue.length === 0) return;
            const cardEl = document.getElementById('active-card');
            cardEl.style.transition = 'transform 0.3s ease, opacity 0.3s ease';
            cardEl.style.transform = 'translate(150%, 0)'; // åƒç°¡å–®ä¸€æ¨£é£›å‡ºå»
            cardEl.style.opacity = '0';

            const currentIndex = studyQueue.shift();
            historyStack.push(currentIndex);
            studyQueue.push(currentIndex); // æ”¾åˆ°æœ€å¾Œé¢

            setTimeout(() => {
                cardEl.style.transition = 'none';
                renderCard();
            }, 300);
        };

        // === 5. æ»‘å‹•æ‰‹å‹¢ç›£è½ ===
        const cardEl = document.getElementById('active-card');
        cardEl.addEventListener('touchstart', e => { touchStartX = e.touches[0].clientX; touchStartY = e.touches[0].clientY; cardEl.style.transition = 'none'; });
        cardEl.addEventListener('touchmove', e => {
            // å¦‚æœæ˜¯åœ¨å°è€ƒæ¨¡å¼ä¸‹çš„ textarea è£¡é¢æ»‘å‹•ï¼Œå°±ä¸è§¸ç™¼å¡ç‰‡æ»‘å‹•ç‰¹æ•ˆ
            if(e.target.tagName.toLowerCase() === 'textarea') return;
            
            const dx = e.touches[0].clientX - touchStartX;
            const dy = e.touches[0].clientY - touchStartY;
            const rotate = dx * 0.05;
            cardEl.style.transform = `translate(${dx}px, ${dy}px) rotate(${rotate}deg)`;
            
            cardEl.classList.remove('swipe-left', 'swipe-right', 'swipe-down');
            if(dx < -80) cardEl.classList.add('swipe-left');
            else if(dx > 80) cardEl.classList.add('swipe-right');
            else if(dy > 80) cardEl.classList.add('swipe-down');
        });
        cardEl.addEventListener('touchend', e => {
            if(e.target.tagName.toLowerCase() === 'textarea') return;
            
            const dx = e.changedTouches[0].clientX - touchStartX;
            const dy = e.changedTouches[0].clientY - touchStartY;
            if(dx < -100) handleAction('left');
            else if(dx > 100) handleAction('right');
            else if(dy > 100) handleAction('down');
            else {
                cardEl.style.transition = 'transform 0.3s ease';
                cardEl.style.transform = 'translate(0,0)';
                cardEl.classList.remove('swipe-left', 'swipe-right', 'swipe-down');
            }
        });

        // === 6. ç†Ÿæ‚‰åº¦åˆ—è¡¨ ===
        window.openStatusList = () => {
            if(!currentBankId) return alert("è«‹å…ˆé¸æ“‡é¡Œåº«");
            openModal('modal-status');
            const tbody = document.getElementById('status-list-body');
            tbody.innerHTML = '';
            
            const now = Date.now();
            allCards.forEach((c, idx) => {
                const p = progressMap[idx];
                let statusHtml = '<span class="tag-new">æ–°é¡Œç›®</span>';
                let sortTime = 0;

                if(p && p.nextReview) {
                    const diff = p.nextReview - now;
                    if(diff <= 0) {
                        statusHtml = '<span class="tag-review">éœ€è¤‡ç¿’</span>';
                        sortTime = -1;
                    } else {
                        const days = Math.ceil(diff / (1000 * 60 * 60 * 24));
                        statusHtml = `<span class="tag-future">${days} å¤©å¾Œ</span>`;
                        sortTime = diff;
                    }
                }

                const tr = document.createElement('tr');
                tr.className = 'status-row';
                tr.onclick = () => jumpToCard(idx);
                tr.innerHTML = `
                    <td>${idx+1}</td>
                    <td style="max-width:200px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${c.q}</td>
                    <td>${statusHtml}</td>
                `;
                tbody.appendChild(tr);
            });
        };

        // å¾åˆ—è¡¨è·³è½‰åˆ°è©²é¡Œ
        window.jumpToCard = (index) => {
            // å¼·åˆ¶å°‡è©²é¡Œæ’å…¥éšŠåˆ—é¦–ä½
            const inQueueIdx = studyQueue.indexOf(index);
            if(inQueueIdx > -1) studyQueue.splice(inQueueIdx, 1);
            
            studyQueue.unshift(index);
            closeModal('modal-status');
            renderCard();
        };

        // === å…¶ä»– UI åŠŸèƒ½ ===
        window.switchBank = (id) => { selectBank(id); toggleSidebar(false); };
        
        function renderSidebar() {
            const list = document.getElementById('bank-list');
            list.innerHTML = '';
            banks.forEach((b) => {
                const div = document.createElement('div');
                div.className = `list-item ${b.id === currentBankId ? 'active' : ''}`;
                
                const sortBtns = `
                    <div class="admin-only" style="display:flex; flex-direction:column; gap:2px; margin-right:8px;">
                        <button onclick="reorderBank('${b.id}', -1)" style="font-size:0.6rem; padding:2px; background:#444; border:none; color:#fff;">â–²</button>
                        <button onclick="reorderBank('${b.id}', 1)" style="font-size:0.6rem; padding:2px; background:#444; border:none; color:#fff;">â–¼</button>
                    </div>`;

                div.innerHTML = `
                    <div style="display:flex; align-items:center;">
                        ${sortBtns}
                        <div onclick="switchBank('${b.id}')" style="flex:1; cursor:pointer;">
                            <div style="color:#fff; font-weight:bold;">${b.title}</div>
                            <div style="color:#888; font-size:0.8rem;">${b.questions.length} é¡Œ</div>
                        </div>
                    </div>
                    <button class="admin-only" onclick="deleteBank('${b.id}')" style="background:none; border:none; color:#e57373;">ğŸ—‘ï¸</button>
                `;
                list.appendChild(div);
            });
        }

        window.reorderBank = async (id, dir) => {
            const idx = banks.findIndex(b => b.id === id);
            if (idx === -1 || idx + dir < 0 || idx + dir >= banks.length) return;
            const b1 = banks[idx], b2 = banks[idx + dir];
            const o1 = b1.order || Date.now(), o2 = b2.order || Date.now() + 1000;
            await updateDoc(doc(db, 'public_question_banks', b1.id), { order: o2 });
            await updateDoc(doc(db, 'public_question_banks', b2.id), { order: o1 });
        };

        window.cycleMask = () => { maskLevel = maskLevel===3 ? 1 : maskLevel+1; renderCard(); };
        
        // ç®¡ç†å“¡åŠŸèƒ½
        window.toggleAdmin = () => {
            if(isAdmin) { isAdmin=false; document.body.classList.remove('is-admin'); document.getElementById('lock-btn').innerText="ğŸ”’"; }
            else if(prompt("å¯†ç¢¼")===ADMIN_PIN) { isAdmin=true; document.body.classList.add('is-admin'); document.getElementById('lock-btn').innerText="ğŸ”“"; }
        };
        
        window.openEdit = () => {
            if(!currentBankId || studyQueue.length===0) return;
            const idx = studyQueue[0];
            const c = allCards[idx];
            document.getElementById('edit-q').value = c.q;
            document.getElementById('edit-a').value = c.a;
            document.getElementById('edit-modal-title').innerText = isAdmin ? "ç›´æ¥ä¿®æ­£" : "æå‡ºå»ºè­°";
            openModal('modal-edit');
        };

        window.submitEdit = async () => {
            const qVal = document.getElementById('edit-q').value;
            const aVal = document.getElementById('edit-a').value;
            const idx = studyQueue[0];
            if(isAdmin) {
                allCards[idx].q = qVal;
                allCards[idx].a = aVal;
                await updateDoc(doc(db, 'public_question_banks', currentBankId), { questions: allCards });
                renderCard(); alert("å·²æ›´æ–°");
            } else {
                await addDoc(collection(db, 'suggestions'), {
                    bankId: currentBankId, bankTitle: banks.find(b=>b.id===currentBankId).title,
                    index: idx, q: qVal, a: aVal, status: 'pending', timestamp: serverTimestamp()
                });
                alert("å·²é€å‡º");
            }
            closeModal('modal-edit');
        };
        
        // å¯©æ ¸èˆ‡åŒ¯å…¥
        function listenForSuggestions() {
            onSnapshot(collection(db, 'suggestions'), s => {
                const c = s.size;
                document.getElementById('review-badge').innerText = c;
                document.getElementById('review-badge').classList.toggle('show', c>0);
            });
        }
        
        window.openReviewModal = async () => {
            if(!isAdmin) return;
            openModal('modal-review');
            const list = document.getElementById('review-list');
            list.innerHTML = 'è®€å–ä¸­...';
            const s = await getDocs(collection(db, 'suggestions'));
            list.innerHTML = '';
            if(s.empty) { list.innerHTML = 'ç„¡å»ºè­°'; return; }
            s.forEach(d => {
                const dd = d.data();
                const el = document.createElement('div');
                el.style.background='#333'; el.style.padding='10px'; el.style.marginBottom='10px';
                el.innerHTML = `<div style="color:#aaa;font-size:0.8rem">${dd.bankTitle}</div><div>Q: ${dd.q}</div><button onclick="approve('${d.id}')">æ‰¹å‡†(åˆªé™¤)</button>`;
                list.appendChild(el);
            });
        };
        
        window.approve = async(id) => { await deleteDoc(doc(db, 'suggestions', id)); window.openReviewModal(); };
        
        window.submitImport = async () => {
            const t = document.getElementById('imp-title').value;
            const txt = document.getElementById('imp-content').value;
            if(!t || !txt) return;
            const regex = /(?:Q:|å•ï¼š|é¡Œç›®ï¼š)(.*?)\n(?:A:|ç­”ï¼š|ç­”æ¡ˆï¼š)([\s\S]*?)(?=(?:Q:|å•ï¼š|é¡Œç›®ï¼š|$))/gi;
            let m, nc = [];
            while ((m = regex.exec(txt)) !== null) nc.push({ q: m[1].trim(), a: m[2].trim() });
            if(nc.length) {
                await addDoc(collection(db, 'public_question_banks'), { title: t, questions: nc, order: Date.now() });
                closeModal('modal-import');
            } else alert("æ ¼å¼éŒ¯èª¤");
        };

        window.deleteBank = async (id) => { if(confirm("åˆªé™¤?")) await deleteDoc(doc(db, 'public_question_banks', id)); };
        
        // Helper
        window.openModal = id => document.getElementById(id).classList.add('active');
        window.closeModal = id => document.getElementById(id).classList.remove('active');
        window.toggleSidebar = show => {
            const s = document.getElementById('sidebar');
            const o = document.querySelector('.sidebar-overlay');
            if(show) { s.classList.add('active'); o.classList.add('active'); }
            else { s.classList.remove('active'); o.classList.remove('active'); }
        };
    </script>
</body>
</html>
