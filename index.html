<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æº–å‰‡å¿«æ†¶é€š SRS</title>
    <style>
        /* --- æ ¸å¿ƒè¨­å®š --- */
        :root {
            --bg-color: #121212;
            --surface-color: #1e1e1e;
            --primary-color: #4caf50;
            --danger-color: #e57373;
            --warning-color: #ffb74d;
            --text-main: #e0e0e0;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0; padding: 0;
            display: flex; flex-direction: column;
            height: 100vh; overflow: hidden;
            user-select: none;
        }

        /* --- å°èˆªåˆ— --- */
        .header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 15px; background-color: var(--surface-color);
            border-bottom: 1px solid #333; z-index: 20;
            height: 50px;
        }
        .header-left { display: flex; align-items: center; gap: 10px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #555; display: inline-block; }
        .status-dot.online { background: #4caf50; box-shadow: 0 0 5px #4caf50; }
        .notification-badge {
            background: var(--danger-color); color: white; font-size: 0.7rem;
            padding: 2px 6px; border-radius: 10px; margin-left: 5px; display: none;
        }
        .notification-badge.show { display: inline-block; }

        /* --- å¡ç‰‡ä¸»é«” (æ»‘å‹•å€) --- */
        .main-container {
            flex: 1; position: relative;
            display: flex; justify-content: center; align-items: center;
            overflow: hidden; perspective: 1000px;
        }

        .card {
            width: 90%; max-width: 600px; height: 80%;
            background: var(--surface-color);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            display: flex; flex-direction: column;
            position: absolute;
            transition: transform 0.3s ease, opacity 0.3s ease;
            box-sizing: border-box;
            border: 1px solid #333;
        }

        /* ä»»å‹™å®Œæˆçš„ç©ºç‹€æ…‹ */
        .empty-state {
            text-align: center; color: #777; display: none;
        }
        .empty-state.show { display: block; }
        .empty-state h2 { color: var(--primary-color); margin-bottom: 10px; }

        .swipe-indicator {
            position: absolute; top: 20px; right: 20px;
            font-size: 2rem; font-weight: bold; opacity: 0;
            border: 4px solid; padding: 5px 10px; border-radius: 8px;
            transform: rotate(15deg); pointer-events: none;
        }
        .swipe-left .indicator-forget { opacity: 1; color: var(--danger-color); border-color: var(--danger-color); }
        .swipe-right .indicator-easy { opacity: 1; color: var(--primary-color); border-color: var(--primary-color); }
        .swipe-down .indicator-blur { opacity: 1; color: var(--warning-color); border-color: var(--warning-color); top: auto; bottom: 20px; }

        .question-box {
            font-size: 1.3rem; font-weight: bold; color: #81c784;
            margin-bottom: 20px; flex-shrink: 0;
        }

        .answer-box {
            font-size: 1.15rem; line-height: 1.8;
            flex: 1; overflow-y: auto; position: relative;
            white-space: pre-wrap;
        }

        /* --- é®ç½©æ¨£å¼ --- */
        .mask-lv1 { background: #333; color: transparent !important; border-radius: 4px; user-select: none; }
        .mask-lv2 { color: #aaa; }
        .mask-lv2 span.hidden-part { display: none; }

        /* å´é‚Šæ¬„èˆ‡ Modal */
        .sidebar-overlay, .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 100; display: none;
        }
        .sidebar {
            position: fixed; top: 0; left: 0; width: 85%; max-width: 320px; height: 100%;
            background: var(--surface-color); z-index: 101;
            transform: translateX(-100%); transition: transform 0.3s;
            display: flex; flex-direction: column; border-right: 1px solid #333;
        }
        .sidebar.active { transform: translateX(0); }
        .modal.active, .sidebar-overlay.active { display: flex; justify-content: center; align-items: center; }
        
        .modal-content {
            background: #1e1e1e; padding: 20px; border-radius: 12px; width: 90%; max-width: 500px;
            display: flex; flex-direction: column; gap: 15px; border: 1px solid #444;
        }

        .list-item {
            padding: 12px; background: #252525; margin-bottom: 8px; border-radius: 6px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .list-item.active { border: 1px solid var(--primary-color); background: #2a3a2a; }
        
        input, textarea {
            width: 100%; background: #2a2a2a; border: 1px solid #444; color: #fff;
            padding: 10px; border-radius: 6px; box-sizing: border-box; font-size: 1rem;
        }
        
        .admin-only { display: none !important; }
        body.is-admin .admin-only { display: flex !important; }

        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #121212; z-index: 999; display: flex; flex-direction: column;
            justify-content: center; align-items: center; color: #fff;
        }
        
        /* æ¨¡å¼åˆ‡æ›æŒ‰éˆ• */
        .mode-switch {
            display: flex; background: #333; border-radius: 20px; padding: 2px; margin-right: 10px;
        }
        .mode-btn {
            padding: 5px 12px; border-radius: 18px; border: none; background: transparent; color: #aaa; font-size: 0.8rem; cursor: pointer;
        }
        .mode-btn.active { background: var(--primary-color); color: #fff; }

    </style>
</head>
<body>

    <div id="loader">
        <div style="font-size: 3rem;">âš¡</div>
        <p id="loader-msg">ç³»çµ±å•Ÿå‹•ä¸­...</p>
    </div>

    <!-- å´é‚Šé¸å–® -->
    <div class="sidebar-overlay" onclick="toggleSidebar(false)"></div>
    <div class="sidebar" id="sidebar">
        <div style="padding:15px; border-bottom:1px solid #333; display:flex; justify-content:space-between; align-items:center;">
            <h3>é¡Œåº«åˆ—è¡¨</h3>
            <button onclick="toggleSidebar(false)" style="background:none; border:none; color:#fff; font-size:1.2rem;">âœ•</button>
        </div>
        <div id="bank-list" style="flex:1; overflow-y:auto; padding:10px;"></div>
        <div class="admin-only" style="padding:15px; border-top:1px solid #333;">
            <button onclick="openModal('modal-import')" style="width:100%; padding:10px; background:var(--primary-color); border:none; border-radius:6px; color:#fff; font-weight:bold;">ï¼‹ æ–°å¢é¡Œåº«</button>
        </div>
    </div>

    <!-- é ‚éƒ¨ -->
    <div class="header">
        <div class="header-left">
            <button onclick="toggleSidebar(true)" style="background:none; border:none; color:#fff; font-size:1.5rem;">â˜°</button>
            <div id="status-dot" class="status-dot"></div>
            <button onclick="openReviewModal()" class="admin-only" style="background:none; border:none; font-size:1.2rem; cursor:pointer; position:relative;">
                ğŸ””<span id="review-badge" class="notification-badge">0</span>
            </button>
        </div>
        
        <!-- å­¸ç¿’æ¨¡å¼åˆ‡æ› -->
        <div class="mode-switch">
            <button class="mode-btn active" id="mode-smart" onclick="setMode('smart')">æ™ºæ…§è¤‡ç¿’</button>
            <button class="mode-btn" id="mode-cram" onclick="setMode('cram')">å…¨éƒ¨ç€è¦½</button>
        </div>

        <button onclick="toggleAdmin()" id="lock-btn" style="background:none; border:none; font-size:1.2rem; cursor:pointer;">ğŸ”’</button>
    </div>

    <!-- å¡ç‰‡å€ -->
    <div class="main-container" id="card-area">
        
        <!-- ä»»å‹™å®Œæˆç•«é¢ -->
        <div id="empty-state" class="empty-state">
            <div style="font-size: 4rem;">ğŸ‰</div>
            <h2>ä»Šæ—¥ä»»å‹™å®Œæˆ</h2>
            <p>é€™å€‹é¡Œåº«ç›®å‰æ²’æœ‰éœ€è¦è¤‡ç¿’çš„å¡ç‰‡ã€‚<br>ä¼‘æ¯ä¸€ä¸‹ï¼Œæ˜å¤©å†ä¾†ï¼</p>
            <button onclick="setMode('cram')" style="margin-top:20px; padding:8px 20px; background:#333; color:#fff; border:1px solid #555; border-radius:20px;">æˆ‘æƒ³å¼·åˆ¶è¤‡ç¿’å…¨éƒ¨</button>
        </div>

        <!-- å¯¦é«”å¡ç‰‡ -->
        <div class="card" id="active-card">
            <div class="swipe-indicator indicator-forget" style="border-color:var(--danger-color); color:var(--danger-color);">å¿˜è¨˜</div>
            <div class="swipe-indicator indicator-easy" style="border-color:var(--primary-color); color:var(--primary-color);">ç°¡å–®</div>
            <div class="swipe-indicator indicator-blur" style="border-color:var(--warning-color); color:var(--warning-color);">æ¨¡ç³Š</div>
            
            <div class="question-box" id="q-text">è«‹é¸æ“‡é¡Œåº«</div>
            
            <!-- å‰©é¤˜é¡Œæ•¸æç¤º -->
            <div style="font-size:0.8rem; color:#666; margin-bottom:10px; text-align:right;">
                å¾…è¤‡ç¿’: <span id="queue-count" style="color:var(--primary-color);">0</span>
            </div>

            <div class="answer-box" id="a-text"></div>
            
            <div style="margin-top:auto; text-align:center; padding-top:10px; border-top:1px solid #333;">
                <button onclick="cycleMask()" id="mask-btn" style="background:#333; border:1px solid #555; color:#aaa; padding:5px 15px; border-radius:20px; font-size:0.8rem;">
                    é®ç½©: Lv2 (æç¤º)
                </button>
                <button onclick="openEdit()" style="background:none; border:none; color:#666; font-size:0.8rem; margin-left:10px;">
                    âœ ä¿®æ­£
                </button>
            </div>
        </div>
    </div>

    <!-- å½ˆçª— -->
    <div id="modal-import" class="modal">
        <div class="modal-content">
            <h3>æ–°å¢é¡Œåº«</h3>
            <input id="imp-title" placeholder="é¡Œåº«åç¨±">
            <textarea id="imp-content" style="height:150px;" placeholder="Q: å•é¡Œ&#10;A: ç­”æ¡ˆ"></textarea>
            <div style="display:flex; gap:10px;">
                <button onclick="closeModal('modal-import')" style="flex:1; padding:10px; background:none; border:1px solid #555; color:#fff; border-radius:6px;">å–æ¶ˆ</button>
                <button onclick="submitImport()" style="flex:1; padding:10px; background:var(--primary-color); border:none; color:#fff; border-radius:6px;">å„²å­˜</button>
            </div>
        </div>
    </div>

    <div id="modal-edit" class="modal">
        <div class="modal-content">
            <h3 id="edit-modal-title">æå‡ºä¿®æ­£å»ºè­°</h3>
            <textarea id="edit-q" style="height:60px;" placeholder="é¡Œç›®"></textarea>
            <textarea id="edit-a" style="height:120px;" placeholder="ç­”æ¡ˆ"></textarea>
            <div style="display:flex; gap:10px;">
                <button onclick="closeModal('modal-edit')" style="flex:1; padding:10px; background:none; border:1px solid #555; color:#fff; border-radius:6px;">å–æ¶ˆ</button>
                <button onclick="submitEdit()" style="flex:1; padding:10px; background:var(--primary-color); border:none; color:#fff; border-radius:6px;">é€å‡º</button>
            </div>
        </div>
    </div>

    <div id="modal-review" class="modal">
        <div class="modal-content" style="max-height:80vh;">
            <h3>å¾…å¯©æ ¸å»ºè­°</h3>
            <div id="review-list" style="overflow-y:auto; flex:1;"></div>
            <button onclick="closeModal('modal-review')" style="padding:10px; background:#333; border:none; color:#fff; border-radius:6px; margin-top:10px;">é—œé–‰</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, serverTimestamp, query, orderBy, onSnapshot, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // === è¨­å®šå€ (ä¿ç•™é‡‘é‘°) ===
        const ADMIN_PIN = "8888";
        const firebaseConfig = {
          apiKey: "AIzaSyC7MgXLY7SwH-gJW71d1jgpPmJwr--I6Mg",
          authDomain: "doctrine-flash.firebaseapp.com",
          projectId: "doctrine-flash",
          storageBucket: "doctrine-flash.firebasestorage.app",
          messagingSenderId: "433425348870",
          appId: "1:433425348870:web:3fd60e44e18d27e1ab8687",
          measurementId: "G-WE3QHJD139"
        };

        // === å…¨åŸŸè®Šæ•¸ ===
        let db, auth, currentUser;
        let banks = [];
        let allCards = []; // è©²é¡Œåº«æ‰€æœ‰å¡ç‰‡
        let studyQueue = []; // ç•¶å‰å¾…åˆ·éšŠåˆ— (å­˜ index)
        let currentBankId = null;
        let maskLevel = 2; 
        let isAdmin = false;
        let touchStartX = 0, touchStartY = 0;
        let studyMode = 'smart'; // 'smart' (SRS) or 'cram' (å…¨éƒ¨)
        let progressMap = {}; // { [index]: nextReviewTime }

        // === åˆå§‹åŒ– ===
        const app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);

        signInAnonymously(auth).catch(e => alert("é€£ç·šå¤±æ•—: " + e.message));
        
        onAuthStateChanged(auth, user => {
            if(user) {
                currentUser = user;
                document.getElementById('status-dot').classList.add('online');
                document.getElementById('loader').style.display = 'none';
                loadBanks();
                listenForSuggestions();
            }
        });

        // === 1. è®€å–é¡Œåº«åˆ—è¡¨ ===
        function loadBanks() {
            const q = query(collection(db, 'public_question_banks'));
            onSnapshot(q, (snapshot) => {
                banks = [];
                snapshot.forEach(d => {
                    const data = d.data();
                    if(data.order === undefined) { // ä¿®å¾©ç„¡æ’åºæ¬„ä½
                         updateDoc(doc(db, 'public_question_banks', d.id), { order: Date.now() });
                    }
                    banks.push({id: d.id, ...data});
                });
                banks.sort((a,b) => (a.order || 0) - (b.order || 0));
                renderSidebar();
                
                // è‡ªå‹•è¼‰å…¥ä¸Šæ¬¡çš„é¡Œåº«
                const saved = JSON.parse(localStorage.getItem('df_progress') || '{}');
                if(!currentBankId && saved.bankId && banks.find(b => b.id === saved.bankId)) {
                    selectBank(saved.bankId);
                }
            });
        }

        // === 2. é¸æ“‡é¡Œåº« & å»ºç«‹è¤‡ç¿’éšŠåˆ— (æ ¸å¿ƒ SRS é‚è¼¯) ===
        window.selectBank = async (id) => {
            const b = banks.find(x => x.id === id);
            if(!b) return;
            
            currentBankId = id;
            allCards = b.questions || [];
            localStorage.setItem('df_progress', JSON.stringify({ bankId: id }));

            // è®€å–å€‹äººé€²åº¦ (ç§æœ‰é›²ç«¯è·¯å¾‘)
            // users/{uid}/progress/{bankId}
            const progRef = doc(db, 'users', currentUser.uid, 'progress', id);
            const progSnap = await getDoc(progRef);
            
            progressMap = progSnap.exists() ? progSnap.data().reviews || {} : {};

            buildQueue(); // æ ¹æ“šæ¨¡å¼å»ºç«‹éšŠåˆ—
            renderSidebar();
        };

        window.setMode = (mode) => {
            studyMode = mode;
            document.getElementById('mode-smart').className = mode === 'smart' ? 'mode-btn active' : 'mode-btn';
            document.getElementById('mode-cram').className = mode === 'cram' ? 'mode-btn active' : 'mode-btn';
            if(currentBankId) buildQueue();
        };

        function buildQueue() {
            studyQueue = [];
            const now = Date.now();

            if (studyMode === 'cram') {
                // å…¨éƒ¨ç€è¦½æ¨¡å¼ï¼šåŠ å…¥æ‰€æœ‰å¡ç‰‡ index
                for(let i=0; i<allCards.length; i++) studyQueue.push(i);
            } else {
                // æ™ºæ…§æ¨¡å¼ï¼šåªåŠ å…¥ "æ–°å¡" æˆ– "åˆ°æœŸå¡"
                for(let i=0; i<allCards.length; i++) {
                    const nextReview = progressMap[i]?.nextReview || 0; // 0 ä»£è¡¨æ–°å¡
                    if (nextReview <= now) {
                        studyQueue.push(i);
                    }
                }
            }

            renderCard();
        }

        // === 3. æ¸²æŸ“å¡ç‰‡ ===
        function renderCard() {
            const cardEl = document.getElementById('active-card');
            const emptyEl = document.getElementById('empty-state');
            const qCount = document.getElementById('queue-count');

            if(studyQueue.length === 0) {
                // éšŠåˆ—ç‚ºç©º -> é¡¯ç¤ºå®Œæˆç•«é¢
                cardEl.style.display = 'none';
                emptyEl.classList.add('show');
                qCount.innerText = "0";
                return;
            }

            // é¡¯ç¤ºå¡ç‰‡
            cardEl.style.display = 'flex';
            cardEl.style.transform = 'translate(0,0) rotate(0deg)';
            cardEl.style.opacity = '1';
            emptyEl.classList.remove('show');
            qCount.innerText = studyQueue.length;

            const idx = studyQueue[0]; // å–éšŠåˆ—ç¬¬ä¸€å€‹
            const c = allCards[idx];
            
            document.getElementById('q-text').innerText = c.q;
            
            const aDiv = document.getElementById('a-text');
            aDiv.innerHTML = '';
            
            // é®ç½©æ¸²æŸ“
            if (maskLevel === 3) {
                aDiv.innerText = c.a;
            } else if (maskLevel === 1) {
                const span = document.createElement('span');
                span.className = 'mask-lv1';
                span.innerText = c.a;
                aDiv.appendChild(span);
            } else {
                const parts = c.a.split(/([ï¼Œã€‚ã€ï¼›ï¼š\n]+)/);
                parts.forEach(p => {
                    if(!p) return;
                    if(/[ï¼Œã€‚ã€ï¼›ï¼š\n]/.test(p)) aDiv.appendChild(document.createTextNode(p));
                    else {
                        const first = p.charAt(0);
                        const rest = p.slice(1);
                        const wrapper = document.createElement('span');
                        wrapper.className = 'mask-lv2';
                        wrapper.innerHTML = `<span style="color:#e0e0e0">${first}</span><span style="background:#333; color:transparent; border-radius:2px;">${rest}</span>`;
                        aDiv.appendChild(wrapper);
                    }
                });
            }
        }

        // === 4. æ»‘å‹•é‚è¼¯èˆ‡æ¼”ç®—æ³•æ›´æ–° (Handle Action) ===
        window.handleAction = async (dir) => {
            if(studyQueue.length === 0) return;

            // å‹•ç•«
            const cardEl = document.getElementById('active-card');
            let trans = '';
            if(dir === 'left') trans = 'translate(-150%, 0) rotate(-20deg)'; // å¿˜è¨˜
            if(dir === 'right') trans = 'translate(150%, 0) rotate(20deg)'; // ç°¡å–®
            if(dir === 'down') trans = 'translate(0, 150%)'; // æ¨¡ç³Š
            
            cardEl.style.transition = 'transform 0.3s ease, opacity 0.3s ease';
            cardEl.style.transform = trans;
            cardEl.style.opacity = '0';

            const currentIndex = studyQueue.shift(); // ç§»é™¤ç•¶å‰å¡ç‰‡
            const now = Date.now();
            
            // æ¼”ç®—æ³•è¨ˆç®— (åƒ…åœ¨æ™ºæ…§æ¨¡å¼ä¸‹å¯«å…¥è³‡æ–™åº«ï¼Œç€è¦½æ¨¡å¼ä¸å½±éŸ¿é€²åº¦)
            if (studyMode === 'smart') {
                let interval = progressMap[currentIndex]?.interval || 0; // å¤©æ•¸
                let nextReview = 0;

                if (dir === 'right') { 
                    // ç°¡å–® (Easy): é€²å…¥é•·æœŸè¨˜æ†¶
                    if (interval === 0) interval = 1; // ç¬¬ä¸€æ¬¡ç­”å°ï¼Œæ˜å¤©è¤‡ç¿’
                    else interval = Math.ceil(interval * 2.5); // æŒ‡æ•¸å¢é•·
                    nextReview = now + (interval * 24 * 60 * 60 * 1000);
                    
                    // å¾éšŠåˆ—ä¸­ç§»é™¤ (ä»Šå¤©ä¸ç”¨å†çœ‹äº†)
                } else if (dir === 'down') {
                    // æ¨¡ç³Š (Blurry): çŸ­æœŸé‡ç¾
                    interval = 0; // é‡ç½®é–“éš”
                    nextReview = now; // å…¶å¯¦æ‡‰è©²è¨­ç‚º +10åˆ†é˜ï¼Œä½†ç‚ºäº†æ–¹ä¾¿ï¼Œè¨­ç‚ºéšŠåˆ—æœ«ç«¯
                    studyQueue.push(currentIndex); // æ”¾å›éšŠåˆ—å°¾ç«¯ï¼Œç¨å¾Œå†èƒŒ
                } else {
                    // å¿˜è¨˜ (Forget): ç«‹å³é‡ç¾
                    interval = 0;
                    nextReview = now;
                    // éš¨æ©Ÿæ’å…¥éšŠåˆ—å‰æ®µ (ä¾‹å¦‚ç¬¬3å¼µå¾Œ)ï¼Œå¼·è¿«çŸ­æœŸè¨˜æ†¶
                    const insertPos = Math.min(studyQueue.length, 3);
                    studyQueue.splice(insertPos, 0, currentIndex);
                }

                // æ›´æ–°æœ¬åœ°è¨˜æ†¶é«”
                progressMap[currentIndex] = { nextReview, interval };
                
                // å¯«å…¥é›²ç«¯ (ä½¿ç”¨ setDoc merge ä»¥å…è¦†è“‹å…¶ä»–é¡Œé€²åº¦)
                const progRef = doc(db, 'users', currentUser.uid, 'progress', currentBankId);
                // ä¸ç­‰å¾…å¯«å…¥å®Œæˆï¼Œç›´æ¥ä¸‹ä¸€é¡Œä»¥ä¿æŒæµæš¢
                setDoc(progRef, { reviews: progressMap }, { merge: true });
            } else {
                // ç€è¦½æ¨¡å¼ (Cram): åªæ˜¯å–®ç´”å¾ªç’°
                if (dir !== 'right') {
                    studyQueue.push(currentIndex); // æ²’èƒŒç†Ÿå°±ä¸Ÿå¾Œé¢
                }
            }

            // ç­‰å¾…å‹•ç•«çµæŸå¾Œæ¸²æŸ“ä¸‹ä¸€å¼µ
            setTimeout(() => {
                cardEl.style.transition = 'none';
                renderCard();
            }, 300);
        };

        // === 5. æ»‘å‹•æ‰‹å‹¢ç›£è½ ===
        const cardEl = document.getElementById('active-card');
        cardEl.addEventListener('touchstart', e => { touchStartX = e.touches[0].clientX; touchStartY = e.touches[0].clientY; cardEl.style.transition = 'none'; });
        cardEl.addEventListener('touchmove', e => {
            const dx = e.touches[0].clientX - touchStartX;
            const dy = e.touches[0].clientY - touchStartY;
            const rotate = dx * 0.05;
            cardEl.style.transform = `translate(${dx}px, ${dy}px) rotate(${rotate}deg)`;
            
            cardEl.classList.remove('swipe-left', 'swipe-right', 'swipe-down');
            if(dx < -80) cardEl.classList.add('swipe-left');
            else if(dx > 80) cardEl.classList.add('swipe-right');
            else if(dy > 80) cardEl.classList.add('swipe-down');
        });
        cardEl.addEventListener('touchend', e => {
            const dx = e.changedTouches[0].clientX - touchStartX;
            const dy = e.changedTouches[0].clientY - touchStartY;
            
            // åˆ¤å®šæ»‘å‹•æ–¹å‘
            if(dx < -100) handleAction('left');
            else if(dx > 100) handleAction('right');
            else if(dy > 100) handleAction('down');
            else {
                // å›å½ˆ
                cardEl.style.transition = 'transform 0.3s ease';
                cardEl.style.transform = 'translate(0,0)';
                cardEl.classList.remove('swipe-left', 'swipe-right', 'swipe-down');
            }
        });

        // === 6. å…¶ä»– UI åŠŸèƒ½ ===
        window.switchBank = (id) => { selectBank(id); toggleSidebar(false); };
        
        function renderSidebar() {
            const list = document.getElementById('bank-list');
            list.innerHTML = '';
            banks.forEach((b) => {
                const div = document.createElement('div');
                div.className = `list-item ${b.id === currentBankId ? 'active' : ''}`;
                
                const sortBtns = `
                    <div class="admin-only" style="display:flex; flex-direction:column; gap:2px; margin-right:8px;">
                        <button onclick="reorderBank('${b.id}', -1)" style="font-size:0.6rem; padding:2px; background:#444; border:none; color:#fff;">â–²</button>
                        <button onclick="reorderBank('${b.id}', 1)" style="font-size:0.6rem; padding:2px; background:#444; border:none; color:#fff;">â–¼</button>
                    </div>`;

                div.innerHTML = `
                    <div style="display:flex; align-items:center;">
                        ${sortBtns}
                        <div onclick="switchBank('${b.id}')" style="flex:1; cursor:pointer;">
                            <div style="color:#fff; font-weight:bold;">${b.title}</div>
                            <div style="color:#888; font-size:0.8rem;">${b.questions.length} é¡Œ</div>
                        </div>
                    </div>
                    <button class="admin-only" onclick="deleteBank('${b.id}')" style="background:none; border:none; color:#e57373;">ğŸ—‘ï¸</button>
                `;
                list.appendChild(div);
            });
        }

        window.reorderBank = async (id, dir) => {
            const idx = banks.findIndex(b => b.id === id);
            if (idx === -1 || idx + dir < 0 || idx + dir >= banks.length) return;
            const b1 = banks[idx], b2 = banks[idx + dir];
            const o1 = b1.order || Date.now(), o2 = b2.order || Date.now() + 1000;
            await updateDoc(doc(db, 'public_question_banks', b1.id), { order: o2 });
            await updateDoc(doc(db, 'public_question_banks', b2.id), { order: o1 });
        };

        window.cycleMask = () => { maskLevel = maskLevel===3 ? 1 : maskLevel+1; renderCard(); document.getElementById('mask-btn').innerText = `é®ç½©: Lv${maskLevel}`; };
        
        // ç®¡ç†å“¡åŠŸèƒ½
        window.toggleAdmin = () => {
            if(isAdmin) { isAdmin=false; document.body.classList.remove('is-admin'); document.getElementById('lock-btn').innerText="ğŸ”’"; }
            else if(prompt("å¯†ç¢¼")===ADMIN_PIN) { isAdmin=true; document.body.classList.add('is-admin'); document.getElementById('lock-btn').innerText="ğŸ”“"; }
        };

        window.openEdit = () => {
            if(!currentBankId || studyQueue.length===0) return;
            const idx = studyQueue[0];
            const c = allCards[idx];
            document.getElementById('edit-q').value = c.q;
            document.getElementById('edit-a').value = c.a;
            document.getElementById('edit-modal-title').innerText = isAdmin ? "ç›´æ¥ä¿®æ­£" : "æå‡ºå»ºè­°";
            openModal('modal-edit');
        };

        window.submitEdit = async () => {
            const qVal = document.getElementById('edit-q').value;
            const aVal = document.getElementById('edit-a').value;
            const idx = studyQueue[0];
            if(isAdmin) {
                allCards[idx].q = qVal; allCards[idx].a = aVal;
                await updateDoc(doc(db, 'public_question_banks', currentBankId), { questions: allCards });
                renderCard(); alert("å·²æ›´æ–°");
            } else {
                await addDoc(collection(db, 'suggestions'), {
                    bankId: currentBankId, bankTitle: banks.find(b=>b.id===currentBankId).title,
                    index: idx, q: qVal, a: aVal, status: 'pending', timestamp: serverTimestamp()
                });
                alert("å·²é€å‡º");
            }
            closeModal('modal-edit');
        };

        // å¯©æ ¸èˆ‡åŒ¯å…¥
        function listenForSuggestions() {
            onSnapshot(collection(db, 'suggestions'), s => {
                const c = s.size;
                document.getElementById('review-badge').innerText = c;
                document.getElementById('review-badge').classList.toggle('show', c>0);
            });
        }
        window.openReviewModal = async () => {
            if(!isAdmin) return;
            openModal('modal-review');
            const list = document.getElementById('review-list');
            list.innerHTML = 'è®€å–ä¸­...';
            const s = await getDocs(collection(db, 'suggestions'));
            list.innerHTML = '';
            if(s.empty) { list.innerHTML = 'ç„¡å»ºè­°'; return; }
            s.forEach(d => {
                const dd = d.data();
                const el = document.createElement('div');
                el.style.background='#333'; el.style.padding='10px'; el.style.marginBottom='10px';
                el.innerHTML = `<div style="color:#aaa;font-size:0.8rem">${dd.bankTitle}</div><div>Q: ${dd.q}</div><button onclick="approve('${d.id}')">æ‰¹å‡†(åˆªé™¤)</button>`;
                list.appendChild(el);
            });
        };
        window.approve = async(id) => { await deleteDoc(doc(db, 'suggestions', id)); window.openReviewModal(); };

        window.submitImport = async () => {
            const t = document.getElementById('imp-title').value;
            const txt = document.getElementById('imp-content').value;
            if(!t || !txt) return;
            const regex = /(?:Q:|å•ï¼š|é¡Œç›®ï¼š)(.*?)\n(?:A:|ç­”ï¼š|ç­”æ¡ˆï¼š)([\s\S]*?)(?=(?:Q:|å•ï¼š|é¡Œç›®ï¼š|$))/gi;
            let m, nc = [];
            while ((m = regex.exec(txt)) !== null) nc.push({ q: m[1].trim(), a: m[2].trim() });
            if(nc.length) {
                await addDoc(collection(db, 'public_question_banks'), { title: t, questions: nc, order: Date.now() });
                closeModal('modal-import');
            } else alert("æ ¼å¼éŒ¯èª¤");
        };

        window.deleteBank = async (id) => { if(confirm("åˆªé™¤?")) await deleteDoc(doc(db, 'public_question_banks', id)); };

        // Helper
        window.openModal = id => document.getElementById(id).classList.add('active');
        window.closeModal = id => document.getElementById(id).classList.remove('active');
        window.toggleSidebar = show => {
            const s = document.getElementById('sidebar');
            const o = document.querySelector('.sidebar-overlay');
            if(show) { s.classList.add('active'); o.classList.add('active'); }
            else { s.classList.remove('active'); o.classList.remove('active'); }
        };
    </script>
</body>
</html>


